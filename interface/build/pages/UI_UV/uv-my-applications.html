<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <title>UV • Tin đã ứng tuyển</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <!-- Fonts & Icons -->
    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700"
      rel="stylesheet"
    />
    <script
      src="https://kit.fontawesome.com/42d5adcbca.js"
      crossorigin="anonymous"
    ></script>

    <!-- Argon -->
    <link href="../../assets/css/nucleo-icons.css" rel="stylesheet" />
    <link href="../../assets/css/nucleo-svg.css" rel="stylesheet" />
    <link
      href="../../assets/css/argon-dashboard-tailwind.css?v=1.0.1"
      rel="stylesheet"
    />

    <style>
      /* Ảnh nền cho toàn bộ main */
      main {
        background: url("../../assets/img/Trangchu.jpg") no-repeat center center;
        background-size: cover;
        position: relative;
      }
      /* Overlay làm mờ nền một chút */
      main::before {
        content: "";
        position: absolute;
        inset: 0;
        background: rgba(255, 255, 255, 0.7);
        z-index: 0;
        border-radius: 0.75rem;
      }
      main > * {
        position: relative;
        z-index: 1;
      }

      /* Custom styles for application cards */
      .application-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(229, 231, 235, 0.5);
        border-radius: 1rem;
        padding: 1.5rem;
        transition: all 0.3s ease;
        margin-bottom: 1rem;
      }
      .application-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      }
      .status-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .status-pending {
        background: #dbeafe;
        color: #1e40af;
      }
      .status-reviewing {
        background: #fef3c7;
        color: #d97706;
      }
      .status-interview {
        background: #dcfce7;
        color: #166534;
      }
      .status-rejected {
        background: #fee2e2;
        color: #dc2626;
      }
      .status-cancelled {
        background: #f3f4f6;
        color: #6b7280;
      }
      .btn-cancel {
        background: #ef4444;
        color: white;
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      .btn-cancel:hover {
        background: #dc2626;
        transform: translateY(-1px);
      }
      .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #64748b;
      }
      .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
      }
    </style>
  </head>
  <body class="m-0 font-sans text-base antialiased bg-gray-50 text-slate-600">
    <!-- Placeholder Sidenav -->
    <div
      id="sidenav-container"
      role="complementary"
      aria-label="Thanh điều hướng ứng viên"
    ></div>

    <script>
      (async function loadSidenav() {
        try {
          const res = await fetch("Sidenav_ungvien.html", {
            cache: "no-store",
          });
          if (!res.ok) throw new Error("HTTP " + res.status);
          const html = await res.text();
          const host = document.getElementById("sidenav-container");
          host.innerHTML = html;

          // Gắn listener Đăng xuất từ trang cha
          const logoutBtn = host.querySelector("#btnLogout");
          if (logoutBtn) {
            logoutBtn.addEventListener("click", function (e) {
              e.preventDefault();
              try {
                localStorage.removeItem("auth");
              } catch {}
              window.location.href = "../UI_SignUp_TD-UV.html";
            });
          }
        } catch (e) {
          console.error("Không thể tải Sidenav_ungvien.html", e);
        }
      })();
    </script>

    <main
      class="relative h-full min-h-screen transition-all duration-200 ease-in-out xl:ml-68 rounded-xl overflow-hidden"
    >
      <!-- Navbar -->
      <nav
        class="mx-6 mt-4 px-6 py-3 bg-white/80 backdrop-blur-md rounded-2xl shadow-md"
      >
        <div class="flex items-center justify-between">
          <h6 class="font-bold">Tin đã ứng tuyển</h6>
          <div class="text-sm text-slate-700">
            Xin chào, <span id="uvEmail">ứng viên</span>
          </div>
        </div>
      </nav>

      <!-- Nội dung -->
      <div class="w-full px-6 py-6 mx-auto">
        <div
          class="bg-white/80 backdrop-blur-md rounded-2xl shadow-xl p-6 mb-6"
        >
          <div class="flex items-center gap-3 mb-4">
            <i class="ni ni-briefcase-24 text-2xl text-blue-500"></i>
            <h3 class="text-xl font-bold text-gray-900">Danh sách ứng tuyển</h3>
          </div>
          <p class="text-gray-600">
            Theo dõi trạng thái các đơn ứng tuyển của bạn
          </p>
        </div>

        <div id="list" class="space-y-4"></div>
      </div>
    </main>

    <script type="module">
      import { BASE_URL, API_BASE } from "../../assets/js/config.js";

      // -------- Guard + helpers ----------
      const authRaw = localStorage.getItem("auth");
      const auth = authRaw ? JSON.parse(authRaw) : null;
      const LOGIN_PAGE =
        BASE_URL + "interface/build/pages/UI_SignUp_TD-UV.html";
      if (
        !auth ||
        !auth.ok ||
        (auth.LoaiTaiKhoan && auth.LoaiTaiKhoan !== "UngVien")
      ) {
        window.location.href = LOGIN_PAGE;
      }
      function getUVId() {
        return Number(
          auth?.MaUngVien ??
            auth?.MaUV ??
            auth?.MaTK ??
            auth?.userId ??
            auth?.id ??
            0
        );
      }
      const UV_EMAIL = auth?.email || auth?.Email || auth?.Email || "";

      // Show header info
      document.getElementById("uvEmail").textContent = UV_EMAIL || "ứng viên";

      async function post(path, body = {}) {
        const res = await fetch(API_BASE + path, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        const data = await res
          .json()
          .catch(() => ({ ok: false, error: "Invalid JSON" }));
        if (!data.ok) throw new Error(data.error || "API error");
        return data;
      }

      function getStatusInfo(status) {
        const statusMap = {
          DangXet: {
            text: "Đang xét duyệt",
            class: "status-reviewing",
            icon: "ni ni-settings-gear-65",
          },
          MoiPhongVan: {
            text: "Mời phỏng vấn",
            class: "status-interview",
            icon: "ni ni-calendar-grid-58",
          },
          TuChoi: {
            text: "Từ chối",
            class: "status-rejected",
            icon: "ni ni-badge",
          },
          Huy: {
            text: "Đã hủy ứng tuyển",
            class: "status-cancelled",
            icon: "ni ni-button-power",
          },
          default: {
            text: "Đã hủy ứng tuyển",
            class: "status-pending",
            icon: "ni ni-time-alarm",
          },
        };
        return statusMap[status] || statusMap["default"];
      }

      async function loadApps() {
        try {
          const r = await post("API_get_UngTuyen_ByUV_All.php", {
            MaTK: getUVId(),
            MaUngVien: getUVId(),
          });
          const list = r.data || [];
          const wrap = document.getElementById("list");
          wrap.innerHTML = "";

          if (!list.length) {
            wrap.innerHTML = `
            <div class="empty-state">
              <i class="ni ni-briefcase-24"></i>
              <h3 class="text-lg font-semibold mb-2">Chưa có đơn ứng tuyển nào</h3>
              <p>Hãy tìm kiếm và ứng tuyển vào các vị trí phù hợp với bạn</p>
            </div>
          `;
            return;
          }

          list.forEach((item) => {
            const statusInfo = getStatusInfo(item.TrangThai);
            const canCancel = item.TrangThai !== "Huy";

            const card = document.createElement("div");
            card.className = "application-card";
            card.innerHTML = `
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <div class="flex items-center gap-3 mb-3">
                  <h4 class="text-lg font-bold text-gray-900">${
                    item.TieuDe || ""
                  }</h4>
                  <span class="status-badge ${statusInfo.class}">
                    <i class="${statusInfo.icon} mr-1"></i>
                    ${statusInfo.text}
                  </span>
                </div>
                <div class="text-gray-600 mb-2">
                  <i class="ni ni-building mr-1"></i>
                  ${item.TenCongTy || ""}
                </div>
                <div class="text-sm text-gray-500">
                  <i class="ni ni-calendar-grid-58 mr-1"></i>
                  Ngày nộp: ${item.NgayNop || "Chưa cập nhật"}
                </div>
                ${
                  item.DiaDiem
                    ? `
                  <div class="text-sm text-gray-500 mt-1">
                    <i class="ni ni-pin-3 mr-1"></i>
                    ${item.DiaDiem}
                  </div>
                `
                    : ""
                }
              </div>
              <div class="flex items-center gap-3">
                ${
                  canCancel
                    ? `
                  <button class="btn-cancel" data-cancel="${item.MaTin}">
                    <i class="ni ni-button-power mr-1"></i>
                    Hủy ứng tuyển
                  </button>
                `
                    : ""
                }
              </div>
            </div>
          `;
            wrap.appendChild(card);
          });
        } catch (error) {
          console.error("Error loading applications:", error);
          document.getElementById("list").innerHTML = `
          <div class="empty-state">
            <i class="ni ni-alert-circle"></i>
            <h3 class="text-lg font-semibold mb-2">Có lỗi xảy ra</h3>
            <p>Không thể tải danh sách ứng tuyển. Vui lòng thử lại sau.</p>
          </div>
        `;
        }
      }

      document.getElementById("list").addEventListener("click", async (e) => {
        const cancel = e.target.closest("[data-cancel]");
        if (cancel) {
          if (!confirm("Bạn có chắc chắn muốn hủy ứng tuyển cho vị trí này?")) {
            return;
          }

          const id = Number(cancel.dataset.cancel);
          const btn = cancel;
          const originalText = btn.innerHTML;
          btn.innerHTML =
            '<i class="ni ni-settings-gear-65 mr-1"></i>Đang xử lý...';
          btn.disabled = true;

          try {
            const r = await post("API_cancel_UngTuyen.php", {
              MaTin: id,
              MaTK: getUVId(),
              MaUngVien: getUVId(),
            });
            if (r.ok) {
              await loadApps();
              alert("Đã hủy ứng tuyển thành công!");
            }
          } catch (err) {
            alert(err.message);
          } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
          }
        }
      });

      // Load applications on page load
      loadApps();
    </script>
  </body>
</html>
