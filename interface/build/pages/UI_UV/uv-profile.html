<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>UV • Thông tin cá nhân</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <!-- Fonts & Icons -->
  <link
    href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700"
    rel="stylesheet"
  />
  <script
    src="https://kit.fontawesome.com/42d5adcbca.js"
    crossorigin="anonymous"
  ></script>

  <!-- Argon -->
  <link href="../../assets/css/nucleo-icons.css" rel="stylesheet" />
  <link href="../../assets/css/nucleo-svg.css" rel="stylesheet" />
  <link
    href="../../assets/css/argon-dashboard-tailwind.css?v=1.0.1"
    rel="stylesheet"
  />

  <style>
    /* Ảnh nền cho toàn bộ main */
    main {
      background: url("../../assets/img/Trangchu.jpg") no-repeat center center;
      background-size: cover;
      position: relative;
    }
    /* Overlay làm mờ nền một chút */
    main::before {
      content: "";
      position: absolute;
      inset: 0;
      background: rgba(255, 255, 255, 0.7);
      z-index: 0;
      border-radius: 0.75rem;
    }
    main > * {
      position: relative;
      z-index: 1;
    }
    
    /* Custom styles for profile form */
    .profile-panel {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(229, 231, 235, 0.5);
      border-radius: 1.5rem;
      padding: 2rem;
      max-width: 900px;
      margin: 0 auto;
    }
    .form-group {
      margin-bottom: 1.5rem;
    }
    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      color: #64748b;
      font-weight: 500;
      font-size: 0.875rem;
    }
    .form-input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid #e2e8f0;
      border-radius: 0.75rem;
      font-size: 0.875rem;
      transition: all 0.3s ease;
    }
    .form-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    .form-input:disabled {
      background-color: #f8fafc;
      color: #64748b;
      cursor: not-allowed;
    }
    .form-textarea {
      resize: vertical;
      min-height: 100px;
    }
    .btn-save {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 0.75rem 2rem;
      border: none;
      border-radius: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 1rem;
    }
    .btn-save:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }
    .message {
      margin-top: 1rem;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      font-size: 0.875rem;
    }
    .message.success {
      background: #ecfdf5;
      color: #166534;
      border: 1px solid #bbf7d0;
    }
    .message.error {
      background: #fef2f2;
      color: #dc2626;
      border: 1px solid #fecaca;
    }
  </style>
</head>
<body class="m-0 font-sans text-base antialiased bg-gray-50 text-slate-600">
  <!-- Placeholder Sidenav -->
  <div
    id="sidenav-container"
    role="complementary"
    aria-label="Thanh điều hướng ứng viên"
  ></div>

  <script>
    (async function loadSidenav() {
      try {
        const res = await fetch("Sidenav_ungvien.html", { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const html = await res.text();
        const host = document.getElementById("sidenav-container");
        host.innerHTML = html;

        // Gắn listener Đăng xuất từ trang cha
        const logoutBtn = host.querySelector("#btnLogout");
        if (logoutBtn) {
          logoutBtn.addEventListener("click", function (e) {
            e.preventDefault();
            try {
              localStorage.removeItem("auth");
            } catch {}
            window.location.href = "../UI_SignUp_TD-UV.html";
          });
        }
      } catch (e) {
        console.error("Không thể tải Sidenav_ungvien.html", e);
      }
    })();
  </script>

  <main
    class="relative h-full min-h-screen transition-all duration-200 ease-in-out xl:ml-68 rounded-xl overflow-hidden"
  >
    <!-- Navbar -->
    <nav
      class="mx-6 mt-4 px-6 py-3 bg-white/80 backdrop-blur-md rounded-2xl shadow-md"
    >
      <div class="flex items-center justify-between">
        <h6 class="font-bold">Thông tin cá nhân</h6>
        <div class="text-sm text-slate-700">
          Xin chào, <span id="uvEmail">ứng viên</span>
        </div>
      </div>
    </nav>

    <!-- Nội dung -->
    <div class="w-full px-6 py-6 mx-auto">
      <div class="profile-panel">
        <div class="text-center mb-8">
          <h3 class="text-2xl font-bold text-gray-900 mb-2">Hồ sơ Ứng viên</h3>
          <p class="text-gray-600">Cập nhật thông tin cá nhân của bạn</p>
        </div>

        <form id="profileForm">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="form-group">
              <label class="form-label">Email (không thể chỉnh sửa)</label>
              <input id="Email" class="form-input" disabled />
            </div>
            <div class="form-group">
              <label class="form-label">Họ tên</label>
              <input id="HoTen" class="form-input" placeholder="Nhập họ tên đầy đủ" />
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="form-group">
              <label class="form-label">Số điện thoại</label>
              <input id="SoDienThoai" class="form-input" placeholder="Nhập số điện thoại" />
            </div>
            <div class="form-group">
              <label class="form-label">Kỹ năng</label>
              <textarea 
                id="KyNang" 
                class="form-input form-textarea" 
                rows="3"
                placeholder="Mô tả các kỹ năng của bạn (ví dụ: JavaScript, React, Node.js, SQL...)"
              ></textarea>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Kinh nghiệm</label>
            <textarea 
              id="KinhNghiem" 
              class="form-input form-textarea" 
              rows="4"
              placeholder="Mô tả kinh nghiệm làm việc của bạn..."
            ></textarea>
          </div>

          <div class="text-center">
            <button type="submit" class="btn-save" id="btnSave">
              <i class="ni ni-save mr-2"></i>
              Lưu cập nhật
            </button>
          </div>

          <div id="msg" class="message" style="display: none;"></div>
        </form>
      </div>
    </div>
  </main>

  <script type="module">
    import { BASE_URL, API_BASE } from "../../assets/js/config.js";

    // -------- Guard + helpers ----------
    const authRaw = localStorage.getItem("auth");
    const auth = authRaw ? JSON.parse(authRaw) : null;
    const LOGIN_PAGE = BASE_URL + "interface/build/pages/UI_SignUp_TD-UV.html";
    if (!auth || !auth.ok || (auth.LoaiTaiKhoan && auth.LoaiTaiKhoan !== "UngVien")) {
      window.location.href = LOGIN_PAGE;
    }
    function getUVId(){
      return Number(auth?.MaUngVien ?? auth?.MaUV ?? auth?.MaTK ?? auth?.userId ?? auth?.id ?? 0);
    }
    const UV_EMAIL = auth?.email || auth?.Email || auth?.Email || "";

    // Show header info
    document.getElementById("uvEmail").textContent = UV_EMAIL || "ứng viên";

    async function post(path, body={}){
      const res = await fetch(API_BASE + path, {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(body)});
      const data = await res.json().catch(()=>({ok:false,error:"Invalid JSON"}));
      if(!data.ok) throw new Error(data.error||"API error");
      return data;
    }

    function showMessage(message, isError = false) {
      const msgEl = document.getElementById("msg");
      msgEl.textContent = message;
      msgEl.className = `message ${isError ? 'error' : 'success'}`;
      msgEl.style.display = 'block';
      
      // Auto hide after 3 seconds
      setTimeout(() => {
        msgEl.style.display = 'none';
      }, 3000);
    }

    async function loadProfile(){
      try{
        const uvId = getUVId();
        console.log("Loading profile for UV ID:", uvId);
        
        // Gọi API với cả MaTK và MaUngVien để tăng khả năng tìm thấy
        const r = await post("API_show_UngVien.php", { 
          MaTK: uvId, 
          MaUngVien: uvId 
        });
        
        const d = r.data || {};
        console.log("Profile data:", d);
        
        Email.value = d.Email || UV_EMAIL || "";
        HoTen.value = d.HoTen || "";
        SoDienThoai.value = d.SoDienThoai || d.SDT || "";
        KyNang.value = d.KyNang || "";
        KinhNghiem.value = d.KinhNghiem || "";
      }catch(e){
        console.error("Error loading profile:", e);
        showMessage(e.message, true);
      }
    }

    document.getElementById("profileForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      
      const btnSave = document.getElementById("btnSave");
      const originalText = btnSave.innerHTML;
      btnSave.innerHTML = '<i class="ni ni-settings-gear-65 mr-2"></i>Đang lưu...';
      btnSave.disabled = true;

      try{
        const body = {
          MaTK:getUVId(),
          MaUngVien:getUVId(),
          HoTen: HoTen.value.trim(),
          SoDienThoai: SoDienThoai.value.trim(),
          KyNang: KyNang.value.trim(),
          KinhNghiem: KinhNghiem.value.trim()
        };
        
        const r = await post("API_update_UngVien.php", body);
        showMessage("Đã lưu hồ sơ thành công!");
      }catch(e){ 
        showMessage(e.message, true);
      } finally {
        btnSave.innerHTML = originalText;
        btnSave.disabled = false;
      }
    });

    // Load profile on page load
    loadProfile();
  </script>
</body>
</html>
