<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>UV • Thông tin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--blue:#3b82f6;--blue-600:#2563eb;--bg:#f6f8fc;--text:#0f172a;--sub:#64748b;--card:#ffffff;--line:#e5e7eb}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial}
    .layout{display:grid;grid-template-columns:260px 1fr;min-height:100vh}
    .sidebar{background:linear-gradient(180deg,var(--blue) 0%,var(--blue-600) 100%);color:#fff;padding:20px 16px}
    .brand{display:flex;align-items:center;gap:10px;margin-bottom:16px}
    .brand .dot{width:12px;height:12px;border-radius:50%;background:#fff;opacity:.9}
    .user{background:rgba(255,255,255,.12);border-radius:16px;padding:14px;text-align:center;margin-bottom:12px}
    .user .avatar{width:56px;height:56px;border-radius:50%;background:#fff;color:var(--blue-600);display:inline-grid;place-content:center;font-weight:700;margin-bottom:6px}
    .nav a,.nav button{display:flex;align-items:center;gap:8px;width:100%;padding:10px 12px;border-radius:10px;border:0;background:transparent;color:#fff;text-decoration:none;cursor:pointer}
    .nav a:hover,.nav button:hover{background:rgba(255,255,255,.14)}
    .main{padding:20px}
    .panel{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;max-width:840px}
    label{display:block;margin:12px 0 6px;color:var(--sub)} input,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn{padding:10px 14px;border-radius:10px;border:0;background:var(--blue);color:#fff;cursor:pointer;margin-top:14px}
    #msg{margin-top:10px}
  </style>
</head>
<body>
<div class="layout">
  <aside class="sidebar">
    <div class="brand"><span class="dot"></span><strong>Ứng viên</strong></div>
    <div class="user">
      <div class="avatar" id="uv-initial">UV</div>
      <div id="uv-email" style="opacity:.9;font-size:13px">...</div>
    </div>
    <nav class="nav">
      <a id="link-home" href="#">🏠 Trang chủ</a>
      <a id="link-profile" href="#">🧾 Thông tin</a>
      <a id="link-apps" href="#">📄 Tin đã ứng tuyển</a>
      <button id="btn-logout">🚪 Đăng xuất</button>
    </nav>
  </aside>

  <main class="main">
    <div class="panel">
      <h3 style="margin:0 0 10px">Hồ sơ Ứng viên</h3>
      <div class="row">
        <div>
          <label>Email (không chỉnh)</label>
          <input id="Email" disabled />
        </div>
        <div>
          <label>Họ tên</label>
          <input id="HoTen" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>Số điện thoại</label>
          <input id="SoDienThoai" />
        </div>
        <div>
          <label>Địa chỉ</label>
          <input id="DiaChi" />
        </div>
      </div>
      <label>Kỹ năng</label>
      <textarea id="KyNang" rows="3"></textarea>
      <label>Kinh nghiệm</label>
      <textarea id="KinhNghiem" rows="4"></textarea>
      <button class="btn" id="btnSave">Lưu cập nhật</button>
      <div id="msg"></div>
    </div>
  </main>
</div>

<script type="module">
  import { BASE_URL, API_BASE } from "../../assets/js/config.js";

  // -------- Guard + helpers ----------
  const authRaw = localStorage.getItem("auth");
  const auth = authRaw ? JSON.parse(authRaw) : null;
  const LOGIN_PAGE = BASE_URL + "interface/build/pages/UI_SignUp_TD-UV.html";
  if (!auth || !auth.ok || (auth.LoaiTaiKhoan && auth.LoaiTaiKhoan !== "UngVien")) {
    window.location.href = LOGIN_PAGE;
  }
  function getUVId(){
    return Number(auth?.MaUngVien ?? auth?.MaUV ?? auth?.MaTK ?? auth?.userId ?? auth?.id ?? 0);
  }
  const UV_EMAIL = auth?.email || auth?.Email || auth?.Email || "";

  // nav + header
  const nav = {
    home: BASE_URL + "interface/build/pages/UI_UV/uv-home.html",
    profile: BASE_URL + "interface/build/pages/UI_UV/uv-profile.html",
    apps: BASE_URL + "interface/build/pages/UI_UV/uv-my-applications.html",
  };
  document.getElementById("link-home").href = nav.home;
  document.getElementById("link-profile").href = nav.profile;
  document.getElementById("link-apps").href = nav.apps;
  document.getElementById("btn-logout").onclick = ()=>{
    localStorage.removeItem("auth");
    window.location.href = LOGIN_PAGE;
  };
  document.getElementById("uv-email").textContent = UV_EMAIL;
  document.getElementById("uv-initial").textContent = (UV_EMAIL||"UV").slice(0,2).toUpperCase();

  async function post(path, body={}){
    const res = await fetch(API_BASE + path, {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(body)});
    const data = await res.json().catch(()=>({ok:false,error:"Invalid JSON"}));
    if(!data.ok) throw new Error(data.error||"API error");
    return data;
  }

  async function loadProfile(){
    try{
      const r = await post("API_show_UngVien.php", { MaTK:getUVId(), MaUngVien:getUVId() });
      const d = r.data||{};
      Email.value = d.Email || UV_EMAIL || "";
      HoTen.value = d.HoTen || "";
      SoDienThoai.value = d.SoDienThoai || d.SDT || "";
      DiaChi.value = d.DiaChi || "";
      KyNang.value = d.KyNang || "";
      KinhNghiem.value = d.KinhNghiem || "";
    }catch(e){
      document.getElementById("msg").style.color="#ef4444";
      document.getElementById("msg").textContent = e.message;
    }
  }

  document.getElementById("btnSave").onclick = async()=>{
    const msg = document.getElementById("msg"); msg.textContent = ""; msg.style.color="#06b6d4";
    try{
      const body = {
        MaTK:getUVId(),
        MaUngVien:getUVId(),
        HoTen: HoTen.value.trim(),
        SoDienThoai: SoDienThoai.value.trim(),
        DiaChi: DiaChi.value.trim(),
        KyNang: KyNang.value.trim(),
        KinhNghiem: KinhNghiem.value.trim()
      };
      // Tùy server: nếu file là API_update_Ungvien.php → đổi tên dưới đây
      const r = await post("API_update_UngVien.php", body);
      msg.textContent = r.ok ? "Đã lưu hồ sơ" : "Lỗi lưu hồ sơ";
    }catch(e){ msg.style.color="#ef4444"; msg.textContent = e.message; }
  };

  loadProfile();
</script>
</body>
</html>
