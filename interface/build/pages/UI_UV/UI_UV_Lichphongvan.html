<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lịch phỏng vấn | Ứng viên</title>

    <!-- Guard -->
    <script>
      (function () {
        try {
          const auth = JSON.parse(localStorage.getItem("auth") || "null");
          if (!auth || !auth.ok || auth.role !== "UngVien") {
            window.location.href = "../UI_SignUp_TD-UV.html";
          }
        } catch {
          window.location.href = "../UI_SignUp_TD-UV.html";
        }
      })();
    </script>

    <!-- Fonts & Icons -->
    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />

    <!-- Argon / Tailwind -->
    <link href="../../assets/css/nucleo-icons.css" rel="stylesheet" />
    <link href="../../assets/css/nucleo-svg.css" rel="stylesheet" />
    <link
      href="../../assets/css/argon-dashboard-tailwind.css?v=1.0.1"
      rel="stylesheet"
    />

    <style>
      body,
      input,
      select,
      textarea,
      button {
        font-family: "Open Sans", ui-sans-serif, system-ui, -apple-system,
          "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      }
      .form-input {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 0.55rem 0.75rem;
        font-size: 0.95rem;
      }
      .btn-primary {
        background: linear-gradient(45deg, #111827, #334155);
        color: #fff;
        padding: 0.55rem 0.9rem;
        border-radius: 0.75rem;
        font-weight: 700;
      }
      .btn-ghost {
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 0.45rem 0.8rem;
      }
      .status-pill {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        font-size: 12px;
        font-weight: 800;
        padding: 2px 8px;
        border-radius: 999px;
      }
      .pill-scheduled {
        background: #ecfeff;
        color: #155e75;
      }
      .pill-done {
        background: #ecfdf5;
        color: #065f46;
      }
      .pill-canceled {
        background: #fff1f2;
        color: #9f1239;
      }
      .actions .btn-ghost {
        font-size: 0.85rem;
      }
      .empty {
        padding: 18px;
        border: 1px dashed #e5e7eb;
        border-radius: 12px;
        color: #6b7280;
        text-align: center;
      }
      .calendar {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 10px;
        margin-top: 20px;
      }
      .calendar .day {
        padding: 10px;
        background: #f1f5f9;
        text-align: center;
        border-radius: 8px;
        cursor: pointer;
      }
      .calendar .day:hover {
        background: linear-gradient(45deg, #111827, #334155);
        color: white;
      }
    </style>
  </head>

  <body class="m-0 bg-gray-50 text-slate-600">
    <!-- Header bg -->
    <div
      class="absolute w-full top-0 min-h-75 bg-[url('https://raw.githubusercontent.com/creativetimofficial/public-assets/master/argon-dashboard-pro/assets/img/profile-layout-header.jpg')] bg-cover bg-center"
    >
      <span
        class="absolute top-0 left-0 w-full h-full bg-blue-500 opacity-60"
      ></span>
    </div>

    <!-- Sidenav -->
    <div id="sidenav-container"></div>
    <script>
      (async function loadSidenav() {
        try {
          const res = await fetch("Sidenav_Ungvien.html", {
            cache: "no-store",
          });
          const html = await res.text();
          const host = document.getElementById("sidenav-container");
          host.innerHTML = html;
          const link = host.querySelector("#navLichPhongVan");
          if (link) link.classList.add("bg-gray-100");
        } catch (e) {
          console.error(e);
        }
      })();
    </script>

    <!-- Main -->
    <div
      class="relative h-full max-h-screen transition-all duration-200 ease-in-out xl:ml-68"
    >
      <nav
        class="absolute z-20 flex items-center justify-between w-full px-6 py-2 -mt-56 text-white"
      >
        <div class="flex items-center justify-between w-full px-6 py-1 mx-auto">
          <div>
            <ol class="flex flex-wrap pt-1 pl-2 pr-4">
              <li><a href="uv-home.html">Trang chủ</a></li>
              <li class="pl-2 before:content-['/']">Lịch phỏng vấn</li>
            </ol>
            <h6 class="mb-2 ml-2 font-bold text-white">
              Lịch phỏng vấn của bạn
            </h6>
          </div>
          <div class="hidden sm:block text-sm">
            <i class="fa fa-user mr-1"></i><span id="oEmail">—</span>
          </div>
        </div>
      </nav>

      <div class="relative w-full mx-auto mt-60">
        <div
          class="relative flex flex-col flex-auto p-4 mx-6 bg-white shadow-3xl rounded-2xl"
        >
          <div class="flex justify-between">
            <div>
              <h5 id="oHoTen" class="mb-1 text-slate-800">Ứng viên</h5>
              <p class="mb-0 text-sm text-slate-500">
                <i class="ni ni-email-83 mr-1"></i><span id="uvEmail">—</span>
              </p>
            </div>
          </div>
        </div>
      </div>

      <div class="w-full p-6 mx-auto">
        <div class="bg-white rounded-2xl shadow-xl p-4">
          <!-- Filters -->
          <div class="flex flex-wrap gap-3 mb-3 mt-4">
            <input
              id="q"
              type="text"
              placeholder="Tìm kiếm..."
              class="form-input"
            />
            <select id="status" class="form-input max-w-[200px]">
              <option value="All">Tất cả</option>
              <option value="DaLenLich">Đã lên lịch</option>
              <option value="HoanThanh">Hoàn thành</option>
              <option value="Huy">Hủy</option>
            </select>
            <label class="inline-flex items-center gap-2 text-sm"
              ><input type="checkbox" id="upcoming" />Chỉ lịch tương lai</label
            >
            <button id="btnReload" class="btn-ghost">
              <i class="fa fa-sync"></i>
            </button>
          </div>

          <ul id="list"></ul>
          <div id="empty" class="empty">—</div>
        </div>
      </div>
    </div>

    <!-- App -->
    <script type="module">
      import { API_BASE } from "../../assets/js/config.js";

      const auth = JSON.parse(localStorage.getItem("auth") || "null");
      document.getElementById("oEmail").textContent =
        auth?.Email || auth?.email || "—";
      document.getElementById("uvEmail").textContent =
        auth?.Email || auth?.email || "—";

      const $q = document.getElementById("q"),
        $status = document.getElementById("status"),
        $upcoming = document.getElementById("upcoming"),
        $btnReload = document.getElementById("btnReload"),
        $list = document.getElementById("list"),
        $empty = document.getElementById("empty"),
        $calendar = document.getElementById("calendar"),
        $btnCreateInterview = document.getElementById("btnCreateInterview");

      let MaUV = null;

      // Generate simple calendar
      const daysInMonth = new Date(
        new Date().getFullYear(),
        new Date().getMonth() + 1,
        0
      ).getDate();
      for (let i = 1; i <= daysInMonth; i++) {
        const dayEl = document.createElement("div");
        dayEl.classList.add("day");
        dayEl.textContent = i;
        dayEl.addEventListener("click", () => alert(`Chọn ngày ${i}`));
        $calendar.appendChild(dayEl);
      }

      // Button to handle interview creation

      async function jget(u) {
        const r = await fetch(u);
        if (!r.ok) throw new Error("HTTP " + r.status);
        return r.json();
      }
      async function jpost(u, data) {
        const r = await fetch(u, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });
        if (!r.ok) throw new Error("HTTP " + r.status);
        return r.json();
      }

      async function loadProfileUV() {
        const prof = await jget(
          API_BASE +
            "API_show_Ungvien.php?MaTK=" +
            encodeURIComponent(auth?.MaTK)
        );
        if (prof?.status === "success" && prof.data?.length) {
          MaUV = prof.data[0].MaUV;
          document.getElementById("oHoTen").textContent = prof.data[0].HoTen;
        }
      }

      function pill(st) {
        if (st === "HoanThanh")
          return '<span class="status-pill pill-done"><i class="fa fa-check"></i> Hoàn thành</span>';
        if (st === "Huy")
          return '<span class="status-pill pill-canceled"><i class="fa fa-xmark"></i> Hủy</span>';
        return '<span class="status-pill pill-scheduled"><i class="fa fa-calendar"></i> Đã lên lịch</span>';
      }

      function renderList(rows) {
        $list.innerHTML = "";
        if (!rows.length) {
          $empty.style.display = "block";
          $empty.textContent = "Không có lịch";
          return;
        }
        $empty.style.display = "none";
        rows.forEach((x) => {
          const li = document.createElement("li");
          li.className = "p-3 border rounded-xl mb-2 bg-white";
          li.innerHTML = `
            <div class="flex justify-between"><div>#${x.MaLichPV} ${pill(
            x.TrangThai
          )}</div><div>${x.NgayGioPhongVan}</div></div>
            <div class="text-sm">Nhà tuyển dụng: <b>${
              x.TenCongTy
            }</b> • Vị trí: <b>${x.ChucDanh}</b> (${x.DiaDiemLamViec})</div>
            ${x.GhiChu ? `<div class="text-sm">Ghi chú: ${x.GhiChu}</div>` : ""}
            <div class="mt-2 actions flex gap-2">
              <button class="btn-ghost" data-cancel="${x.MaLichPV}">Hủy</button>
            </div>`;
          $list.appendChild(li);
        });
        $list
          .querySelectorAll("[data-cancel]")
          .forEach(
            (btn) => (btn.onclick = () => setStatus(btn.dataset.cancel, "Huy"))
          );
      }

      async function loadList() {
        const qs = new URLSearchParams({ MaUV, limit: 500 });
        if ($status.value !== "All") qs.set("status", $status.value);
        if ($upcoming.checked) qs.set("upcoming", "1");
        if ($q.value.trim()) qs.set("q", $q.value.trim());
        const js = await jget(
          API_BASE + "API_lpv_list_for_uv.php?" + qs.toString()
        );
        renderList(js?.items || []);
      }

      async function setStatus(MaLichPV, TrangThai) {
        const js = await jpost(API_BASE + "API_lpv_set_status.php", {
          MaUV,
          MaLichPV,
          TrangThai,
        });
        if (js.ok) loadList();
        else alert(js.error);
      }

      $q.oninput =
        $status.onchange =
        $upcoming.onchange =
        $btnReload.onclick =
          () => loadList();

      (async function init() {
        await loadProfileUV();
        if (MaUV) loadList();
      })();
    </script>
  </body>
</html>
