```html
<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lịch phỏng vấn | Ứng viên</title>

    <!-- Guard -->
    <script>
      (function () {
        try {
          const auth = JSON.parse(localStorage.getItem("auth") || "null");
          if (!auth || !auth.ok || auth.LoaiTaiKhoan !== "UngVien") {
            window.location.href = "../UI_SignUp_TD-UV.html?logged_out=1";
          }
        } catch {
          window.location.href = "../UI_SignUp_TD-UV.html?logged_out=1";
        }
      })();
    </script>

    <!-- Fonts & Icons -->
    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css"
    />

    <!-- Argon / Tailwind -->
    <link href="../../assets/css/nucleo-icons.css" rel="stylesheet" />
    <link href="../../assets/css/nucleo-svg.css" rel="stylesheet" />
    <link
      href="../../assets/css/argon-dashboard-tailwind.css?v=1.0.1"
      rel="stylesheet"
    />

    <style>
      body,
      input,
      select,
      textarea,
      button {
        font-family: "Open Sans", ui-sans-serif, system-ui, -apple-system,
          "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      }
      .form-input {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 0.55rem 0.75rem;
        font-size: 0.95rem;
      }
      .btn-primary {
        background: linear-gradient(45deg, #111827, #334155);
        color: #fff;
        padding: 0.55rem 0.9rem;
        border-radius: 0.75rem;
        font-weight: 700;
      }
      .btn-ghost {
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 0.45rem 0.8rem;
      }
      .status-pill {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        font-size: 12px;
        font-weight: 800;
        padding: 2px 8px;
        border-radius: 999px;
      }
      .pill-scheduled {
        background: #ecfeff;
        color: #155e75;
      }
      .pill-done {
        background: #ecfdf5;
        color: #065f46;
      }
      .pill-canceled {
        background: #fff1f2;
        color: #9f1239;
      }
      .actions .btn-ghost {
        font-size: 0.85rem;
      }
      .empty {
        padding: 18px;
        border: 1px dashed #e5e7eb;
        border-radius: 12px;
        color: #6b7280;
        text-align: center;
      }
    </style>
  </head>

  <body class="m-0 bg-gray-50 text-slate-600">
    <!-- Header bg -->
    <div
      class="absolute w-full top-0 min-h-75 bg-[url('https://raw.githubusercontent.com/creativetimofficial/public-assets/master/argon-dashboard-pro/assets/img/profile-layout-header.jpg')] bg-cover bg-center"
    >
      <span
        class="absolute top-0 left-0 w-full h-full bg-blue-500 opacity-60"
      ></span>
    </div>

    <!-- Sidenav -->
    <div
      id="sidenav-container"
      role="complementary"
      aria-label="Thanh điều hướng ứng viên"
    ></div>
    <script>
      (async function loadSidenav() {
        try {
          const res = await fetch("Sidenav_ungvien.html", {
            cache: "no-store",
          });
          console.log("Sidenav fetch status:", res.status);
          if (!res.ok) throw new Error("HTTP " + res.status);
          const html = await res.text();
          const host = document.getElementById("sidenav-container");
          host.innerHTML = html;
          const link = host.querySelector("a[href='UI_UV_Lichphongvan.html']");
          if (link) {
            link.classList.add("bg-gray-100", "text-blue-600");
            link.querySelector("i")?.classList.add("text-blue-600");
          }
          const logoutBtn = host.querySelector("#btnLogout");
          if (logoutBtn) {
            logoutBtn.addEventListener("click", async (e) => {
              e.preventDefault();
              try {
                localStorage.removeItem("auth");
                sessionStorage.clear();
              } catch {}
              window.location.href = "../UI_SignUp_TD-UV.html?logged_out=1";
            });
          }
        } catch (e) {
          console.error("Không thể tải Sidenav_ungvien.html:", e);
          showToast("Lỗi tải menu điều hướng", "error");
        }
      })();
    </script>

    <!-- Main -->
    <div
      class="relative h-full max-h-screen transition-all duration-200 ease-in-out xl:ml-68"
    >
      <nav
        class="absolute z-20 flex items-center justify-between w-full px-6 py-2 -mt-56 text-white"
      >
        <div class="flex items-center justify-between w-full px-6 py-1 mx-auto">
          <div>
            <ol class="flex flex-wrap pt-1 pl-2 pr-4">
              <li><a href="UI_Ungvien_Trangchu.html">Trang chủ</a></li>
              <li class="pl-2 before:content-['/']">Lịch phỏng vấn</li>
            </ol>
            <h6 class="mb-2 ml-2 font-bold text-white">
              Lịch phỏng vấn của bạn
            </h6>
          </div>
          <div class="hidden sm:block text-sm">
            <i class="fa fa-user mr-1"></i><span id="oEmail">—</span>
          </div>
        </div>
      </nav>

      <div class="relative w-full mx-auto mt-60">
        <div
          class="relative flex flex-col flex-auto p-4 mx-6 bg-white shadow-3xl rounded-2xl"
        >
          <div class="flex justify-between">
            <div>
              <h5 id="oHoTen" class="mb-1 text-slate-800">Ứng viên</h5>
              <p class="mb-0 text-sm text-slate-500">
                <i class="ni ni-email-83 mr-1"></i><span id="uvEmail">—</span>
              </p>
            </div>
          </div>
        </div>
      </div>

      <div class="w-full p-6 mx-auto">
        <div class="bg-white rounded-2xl shadow-xl p-4">
          <!-- Filters -->
          <div class="flex flex-wrap gap-3 mb-3 mt-4">
            <input
              id="q"
              type="text"
              placeholder="Tìm kiếm..."
              class="form-input"
            />
            <select id="status" class="form-input max-w-[200px]">
              <option value="All">Tất cả</option>
              <option value="DaLenLich">Đã lên lịch</option>
              <option value="HoanThanh">Hoàn thành</option>
              <option value="Huy">Hủy</option>
            </select>
            <label class="inline-flex items-center gap-2 text-sm">
              <input type="checkbox" id="upcoming" />Chỉ lịch tương lai
            </label>
            <button id="btnReload" class="btn-ghost">
              <i class="fa fa-sync"></i>
            </button>
          </div>

          <ul id="list"></ul>
          <div id="empty" class="empty">—</div>
        </div>
      </div>
    </div>

    <!-- App -->
    <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>
    <script type="module">
      import { API_BASE } from "../../assets/js/config.js";

      const notyf = new Notyf();
      function showToast(message, type = "success") {
        notyf.open({ type, message, duration: 3000 });
      }

      const auth = JSON.parse(localStorage.getItem("auth") || "null");
      if (!auth || !auth.ok || auth.LoaiTaiKhoan !== "UngVien") {
        console.error("Invalid auth:", auth);
        showToast("Phiên đăng nhập không hợp lệ", "error");
        window.location.href = "../UI_SignUp_TD-UV.html?logged_out=1";
      }
      document.getElementById("oEmail").textContent =
        auth?.Email || auth?.email || "—";
      document.getElementById("uvEmail").textContent =
        auth?.Email || auth?.email || "—";

      const $q = document.getElementById("q");
      const $status = document.getElementById("status");
      const $upcoming = document.getElementById("upcoming");
      const $btnReload = document.getElementById("btnReload");
      const $list = document.getElementById("list");
      const $empty = document.getElementById("empty");

      let MaUV = null;

      async function jget(u) {
        console.log("Fetching:", u);
        const r = await fetch(u, { cache: "no-store" });
        if (!r.ok) {
          console.error("Fetch failed:", u, "Status:", r.status);
          throw new Error("HTTP " + r.status);
        }
        const ct = (r.headers.get("content-type") || "").toLowerCase();
        const txt = await r.text();
        if (!ct.includes("application/json")) {
          console.error("API returned non-JSON:\n", txt);
          throw new Error("API không trả JSON hợp lệ");
        }
        try {
          return JSON.parse(txt);
        } catch {
          console.error("API returned invalid JSON:\n", txt);
          throw new Error("JSON parse failed");
        }
      }

      async function jpost(u, data) {
        console.log("Posting to:", u, "Data:", data);
        const r = await fetch(u, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });
        if (!r.ok) {
          console.error("Post failed:", u, "Status:", r.status);
          throw new Error("HTTP " + r.status);
        }
        return r.json();
      }

      async function loadProfileUV() {
        try {
          if (!auth?.MaTK) {
            throw new Error("Không tìm thấy MaTK trong auth");
          }
          const url =
            API_BASE +
            "API_show_Ungvien.php?MaTK=" +
            encodeURIComponent(auth.MaTK);
          console.log("Fetching profile:", url);
          const prof = await jget(url);
          console.log("Profile response:", prof);
          if (prof?.ok && prof.data) {
            MaUV = Number(prof.data.MaUngVien || prof.data.MaUV);
            if (!MaUV) {
              throw new Error(
                "Không tìm thấy MaUngVien hoặc MaUV trong dữ liệu"
              );
            }
            console.log("MaUV:", MaUV);
            document.getElementById("oHoTen").textContent =
              prof.data.HoTen || "Ứng viên";
          } else {
            throw new Error(
              `API trả về dữ liệu không hợp lệ: ${JSON.stringify(prof)}`
            );
          }
        } catch (err) {
          console.error("Lỗi tải thông tin ứng viên:", err);
          showToast(`Lỗi tải thông tin cá nhân: ${err.message}`, "error");
        }
      }

      function pill(st) {
        if (st === "HoanThanh")
          return '<span class="status-pill pill-done"><i class="fa fa-check"></i> Hoàn thành</span>';
        if (st === "Huy")
          return '<span class="status-pill pill-canceled"><i class="fa fa-xmark"></i> Hủy</span>';
        return '<span class="status-pill pill-scheduled"><i class="fa fa-calendar"></i> Đã lên lịch</span>';
      }

      function renderList(rows) {
        console.log("Rendering list with rows:", rows);
        $list.innerHTML = "";
        if (!rows.length) {
          $empty.style.display = "block";
          $empty.textContent = "Không có lịch phỏng vấn";
          return;
        }
        $empty.style.display = "none";
        rows.forEach((x) => {
          const li = document.createElement("li");
          li.className = "p-3 border rounded-xl mb-2 bg-white";
          li.innerHTML = `
            <div class="flex justify-between">
              <div>#${x.MaLichPV} ${pill(x.TrangThai)}</div>
              <div>${new Date(x.NgayGioPhongVan).toLocaleString("vi-VN")}</div>
            </div>
            <div class="text-sm">Nhà tuyển dụng: <b>${
              x.TenCongTy
            }</b> • Vị trí: <b>${x.ChucDanh}</b> (${x.DiaDiemLamViec})</div>
            <div class="text-sm">Hình thức: <b>${
              x.HinhThuc || "Chưa xác định"
            }</b></div>
            ${x.GhiChu ? `<div class="text-sm">Ghi chú: ${x.GhiChu}</div>` : ""}
            <div class="mt-2 actions flex gap-2">
              
            </div>`;
          $list.appendChild(li);
        });
        $list.querySelectorAll("[data-cancel]").forEach((btn) => {
          btn.onclick = () => setStatus(btn.dataset.cancel, "Huy");
        });
      }

      async function loadList() {
        if (!MaUV) {
          console.error("MaUV is null");
          showToast("Không xác định được ứng viên", "error");
          return;
        }
        const qs = new URLSearchParams({ MaUngVien: MaUV, limit: 500 });
        if ($status.value !== "All") qs.set("status", $status.value);
        if ($upcoming.checked) qs.set("upcoming", "1");
        if ($q.value.trim()) qs.set("q", $q.value.trim());
        try {
          const url = API_BASE + "API_lpv_list_for_uv.php?" + qs.toString();
          console.log("Fetching list:", url);
          const js = await jget(url);
          console.log("List response:", js);
          renderList(js?.items || []);
        } catch (err) {
          console.error("Lỗi tải danh sách lịch phỏng vấn:", err);
          showToast(
            "Lỗi tải danh sách lịch phỏng vấn: " + err.message,
            "error"
          );
        }
      }

      async function setStatus(MaLichPV, TrangThai) {
        try {
          const js = await jpost(API_BASE + "API_lpv_set_status.php", {
            MaUngVien: MaUV,
            MaLichPV,
            TrangThai,
          });
          if (js.ok) {
            showToast("Cập nhật trạng thái thành công", "success");
            loadList();
          } else {
            throw new Error(js.error || "Cập nhật trạng thái thất bại");
          }
        } catch (err) {
          console.error("Lỗi cập nhật trạng thái:", err);
          showToast("Lỗi cập nhật trạng thái: " + err.message, "error");
        }
      }

      $q.oninput =
        $status.onchange =
        $upcoming.onchange =
        $btnReload.onclick =
          () => loadList();

      (async function init() {
        await loadProfileUV();
        if (MaUV) await loadList();
      })();
    </script>
  </body>
</html>
```
