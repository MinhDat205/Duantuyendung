<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>UV • Trang chủ</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <!-- Fonts & Icons -->
  <link
    href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700"
    rel="stylesheet"
  />
  <script
    src="https://kit.fontawesome.com/42d5adcbca.js"
    crossorigin="anonymous"
  ></script>

  <!-- Argon -->
  <link href="../../assets/css/nucleo-icons.css" rel="stylesheet" />
  <link href="../../assets/css/nucleo-svg.css" rel="stylesheet" />
  <link
    href="../../assets/css/argon-dashboard-tailwind.css?v=1.0.1"
    rel="stylesheet"
  />

  <style>
    /* Ảnh nền cho toàn bộ main */
    main {
      background: url("../../assets/img/Trangchu.jpg") no-repeat center center;
      background-size: cover;
      position: relative;
    }
    /* Overlay làm mờ nền một chút */
    main::before {
      content: "";
      position: absolute;
      inset: 0;
      background: rgba(255, 255, 255, 0.7);
      z-index: 0;
      border-radius: 0.75rem;
    }
    main > * {
      position: relative;
      z-index: 1;
    }
    
    /* Custom styles for job cards */
    .job-card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(229, 231, 235, 0.5);
      border-radius: 1rem;
      padding: 1.5rem;
      transition: all 0.3s ease;
    }
    .job-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
    .search-panel {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(229, 231, 235, 0.5);
      border-radius: 1rem;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .tag {
      background: #eef2ff;
      color: #3730a3;
      border-radius: 9999px;
      padding: 0.25rem 0.75rem;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .badge {
      border-radius: 0.5rem;
      padding: 0.25rem 0.75rem;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .badge.applied {
      background: #ecfdf5;
      color: #166534;
    }
    .badge.cancelled {
      background: #fef2f2;
      color: #dc2626;
    }
    .badge.default {
      background: #ecfeff;
      color: #0e7490;
    }
  </style>
</head>
<body class="m-0 font-sans text-base antialiased bg-gray-50 text-slate-600">
  <!-- Placeholder Sidenav -->
  <div
    id="sidenav-container"
    role="complementary"
    aria-label="Thanh điều hướng ứng viên"
  ></div>

  <script>
    (async function loadSidenav() {
      try {
        const res = await fetch("Sidenav_ungvien.html", { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const html = await res.text();
        const host = document.getElementById("sidenav-container");
        host.innerHTML = html;

        // Gắn listener Đăng xuất từ trang cha
        const logoutBtn = host.querySelector("#btnLogout");
        if (logoutBtn) {
          logoutBtn.addEventListener("click", function (e) {
            e.preventDefault();
            try {
              localStorage.removeItem("auth");
            } catch {}
            window.location.href = "../UI_SignUp_TD-UV.html";
          });
        }
      } catch (e) {
        console.error("Không thể tải Sidenav_ungvien.html", e);
      }
    })();
  </script>

  <main
    class="relative h-full min-h-screen transition-all duration-200 ease-in-out xl:ml-68 rounded-xl overflow-hidden"
  >
    <!-- Navbar -->
    <nav
      class="mx-6 mt-4 px-6 py-3 bg-white/80 backdrop-blur-md rounded-2xl shadow-md"
    >
      <div class="flex items-center justify-between">
        <h6 class="font-bold">Trang chủ Ứng viên</h6>
        <div class="text-sm text-slate-700">
          Xin chào, <span id="uvEmail">ứng viên</span>
        </div>
      </div>
    </nav>

    <!-- Nội dung -->
    <div class="w-full px-6 py-6 mx-auto">
      <!-- Search Panel -->
      <div class="search-panel">
        <div class="flex items-center gap-4 flex-wrap">
          <input 
            id="kw" 
            placeholder="Tìm theo từ khóa (tiêu đề, mô tả, công ty)..." 
            class="flex-1 min-w-64 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
          <input 
            id="addr" 
            placeholder="Địa chỉ (vd: Hà Nội, TP.HCM)" 
            class="min-w-48 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            list="addrList"
          />
          <datalist id="addrList"></datalist>
          <button 
            id="btnSearch"
            class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors"
          >
            Tìm kiếm
          </button>
          <span class="text-sm text-gray-600">
            <span id="result-count">Đang tải...</span>
          </span>
        </div>
      </div>

      <!-- Job List -->
      <div id="list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </div>
  </main>

  <script type="module">
    import { BASE_URL, API_BASE } from "../../assets/js/config.js";

    // ----------------- Guard + common helpers -----------------
    const authRaw = localStorage.getItem("auth");
    const auth = authRaw ? JSON.parse(authRaw) : null;
    const LOGIN_PAGE = BASE_URL + "interface/build/pages/UI_SignUp_TD-UV.html";
    if (!auth || !auth.ok || (auth.LoaiTaiKhoan && auth.LoaiTaiKhoan !== "UngVien")) {
      window.location.href = LOGIN_PAGE;
    }
    function getUVId(){
      return Number(auth?.MaUngVien ?? auth?.MaUV ?? auth?.MaTK ?? auth?.userId ?? auth?.id ?? 0);
    }
    const UV_EMAIL = auth?.email || auth?.Email || auth?.Email || "";

    // Show header info
    document.getElementById("uvEmail").textContent = UV_EMAIL || "ứng viên";

    async function post(path, body={}){
      const res = await fetch(API_BASE + path, {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(body)});
      const data = await res.json().catch(()=>({ok:false,error:"Invalid JSON"}));
      if(!data.ok) throw new Error(data.error||"API error");
      return data;
    }

    // Locations for datalist
    async function loadLocations(){
      try{
        const r = await fetch(API_BASE + "API_list_DiaDiem.php").then(r=>r.json());
        const list = Array.isArray(r?.data)? r.data : [];
        const dl = document.getElementById("addrList"); dl.innerHTML = "";
        list.forEach(v => { const o = document.createElement("option"); o.value = v; dl.appendChild(o); });
      }catch{}
    }

    // Applied markers
    let appliedIds = new Set();
    let cancelledIds = new Set();
    async function loadApplied(){
      try{
        const r = await post("API_get_UngTuyen_ByUV_All.php",{ MaTK:getUVId(), MaUngVien:getUVId() });
        (r.data||[]).forEach(it => {
          if (it.TrangThai === 'Huy') {
            cancelledIds.add(Number(it.MaTin));
          } else {
            appliedIds.add(Number(it.MaTin));
          }
        });
      }catch{}
    }

    // Search + render
    async function search(){
      document.getElementById("result-count").textContent = "Đang tải...";
      const body = {
        keyword: document.getElementById("kw").value.trim(),
        diaDiem: document.getElementById("addr").value.trim(),
        MaTK: getUVId(),
        MaUngVien: getUVId()
      };
      const r = await post("API_search_TinTuyenDung.php", body);
      render(r.data||[]);
    }

    const listEl = document.getElementById("list");
    function render(items){
      document.getElementById("result-count").textContent = `${items.length} tin tuyển dụng`;
      listEl.innerHTML = "";
      items.forEach(j=>{
        const applied = appliedIds.has(Number(j.MaTin));
        const cancelled = cancelledIds.has(Number(j.MaTin));
        const card = document.createElement("div");
        card.className = "job-card";
        card.innerHTML = `
          <div class="flex flex-col h-full">
            <div class="flex-1">
              <h3 class="text-lg font-bold text-gray-900 mb-2">${j.TieuDe||""}</h3>
              <p class="text-gray-600 mb-2">${j.TenCongTy||""}</p>
              <p class="text-sm text-gray-500 mb-3">${j.DiaDiem||""} • ${(j.LuongTu??"")} ${j.LuongTu!=null?"-":""} ${(j.LuongDen??"")}</p>
              ${j.MoTaNgan? `<p class="text-sm text-gray-600 mb-3">${j.MoTaNgan}</p>`:""}
              <div class="flex flex-wrap gap-2 mb-4">
                ${(j.NganhNghe||"").split(",").filter(Boolean).map(x=>`<span class="tag">${x.trim()}</span>`).join("")}
              </div>
            </div>
            <div class="flex items-center justify-between">
              <span class="badge ${cancelled?"cancelled":applied?"applied":"default"}" id="st-${j.MaTin}">
                ${cancelled ? "Đã hủy" : applied ? "Đã ứng tuyển" : "Chưa ứng tuyển"}
              </span>
              <div class="flex gap-2">
                <button class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors ${(applied||cancelled)?"hidden":""}" data-apply="${j.MaTin}">
                  Ứng tuyển
                </button>
                <button class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors ${applied?"":"hidden"}" data-cancel="${j.MaTin}">
                  Hủy
                </button>
              </div>
            </div>
          </div>
        `;
        listEl.appendChild(card);
      });
    }

    listEl.addEventListener("click", async (e)=>{
      const apply = e.target.closest("[data-apply]");
      const cancel = e.target.closest("[data-cancel]");
      if(apply){
        const id = Number(apply.dataset.apply);
        try{
          const r = await post("API_apply_TinTuyenDung.php",{ MaTin:id, MaTK:getUVId(), MaUngVien:getUVId() });
          if(r.ok){
            await loadApplied();
            await search();
            alert("Đã ứng tuyển thành công!");
          }
        }catch(err){ alert(err.message); }
      }
      if(cancel){
        const id = Number(cancel.dataset.cancel);
        try{
          const r = await post("API_cancel_UngTuyen.php",{ MaTin:id, MaTK:getUVId(), MaUngVien:getUVId() });
          if(r.ok){
            await loadApplied();
            await search();
            alert("Đã hủy ứng tuyển thành công!");
          }
        }catch(err){ alert(err.message); }
      }
    });

    // Init
    (async ()=>{
      await Promise.all([loadLocations(), loadApplied()]);
      await search();
      document.getElementById("btnSearch").onclick = search;
    })();
  </script>
</body>
</html>
