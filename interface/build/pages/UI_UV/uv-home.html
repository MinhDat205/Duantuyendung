<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>UV ‚Ä¢ Trang ch·ªß</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --blue:#3b82f6;--blue-600:#2563eb;--bg:#f6f8fc;--text:#0f172a;--sub:#64748b;
      --card:#ffffff;--line:#e5e7eb;--green:#22c55e;--red:#ef4444;
    }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial}
    .layout{display:grid;grid-template-columns:260px 1fr;min-height:100vh}
    /* Sidebar */
    .sidebar{background:linear-gradient(180deg,var(--blue) 0%,var(--blue-600) 100%);color:#fff;padding:20px 16px}
    .brand{display:flex;align-items:center;gap:10px;margin-bottom:16px}
    .brand .dot{width:12px;height:12px;border-radius:50%;background:#fff;opacity:.9}
    .user{background:rgba(255,255,255,.12);border-radius:16px;padding:14px;text-align:center;margin-bottom:12px}
    .user .avatar{width:56px;height:56px;border-radius:50%;background:#fff;color:var(--blue-600);display:inline-grid;place-content:center;font-weight:700;margin-bottom:6px}
    .nav a,.nav button{display:flex;align-items:center;gap:8px;width:100%;padding:10px 12px;border-radius:10px;border:0;background:transparent;color:#fff;text-decoration:none;cursor:pointer}
    .nav a:hover,.nav button:hover{background:rgba(255,255,255,.14)}
    .logout{margin-top:auto}
    /* Main */
    .main{padding:20px}
    .topbar{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px 16px;margin-bottom:16px;display:flex;gap:10px;flex-wrap:wrap}
    .topbar input,.topbar select,.topbar button{padding:10px 12px;border:1px solid var(--line);border-radius:10px;font:inherit}
    .topbar button{background:var(--blue);color:#fff;border:0}
    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    @media(max-width:1100px){.grid{grid-template-columns:repeat(2,minmax(0,1fr));}}
    @media(max-width:720px){.layout{grid-template-columns:1fr}.sidebar{position:sticky;top:0}.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;display:flex;gap:12px;justify-content:space-between}
    .meta{color:var(--sub);font-size:13px;margin-top:4px}
    .tags{margin-top:6px;display:flex;gap:6px;flex-wrap:wrap}
    .tag{background:#eef2ff;color:#3730a3;border-radius:999px;padding:3px 8px;font-size:12px}
    .actions{display:flex;gap:8px;align-items:center}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .btn.primary{background:var(--blue);color:#fff;border:0}
    .badge{background:#ecfeff;color:#0e7490;border-radius:8px;padding:4px 8px;font-size:12px}
    .applied{background:#ecfdf5;color:#166534}
    .cancelled{background:#fef2f2;color:#dc2626}
  </style>
</head>
<body>
<div class="layout">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand"><span class="dot"></span><strong>·ª®ng vi√™n</strong></div>
    <div class="user">
      <div class="avatar" id="uv-initial">UV</div>
      <div id="uv-email" style="opacity:.9;font-size:13px">...</div>
    </div>
    <nav class="nav">
      <a id="link-home" href="#">üè† Trang ch·ªß</a>
      <a id="link-profile" href="#">üßæ Th√¥ng tin</a>
      <a id="link-apps" href="#">üìÑ Tin ƒë√£ ·ª©ng tuy·ªÉn</a>
      <button class="logout" id="btn-logout">üö™ ƒêƒÉng xu·∫•t</button>
    </nav>
  </aside>

  <!-- Main -->
  <main class="main">
    <div class="topbar">
      <input id="kw" placeholder="T√¨m theo t·ª´ kh√≥a (ti√™u ƒë·ªÅ, m√¥ t·∫£, c√¥ng ty)..." style="min-width:260px" />
      <input id="addr" placeholder="ƒê·ªãa ch·ªâ (vd: H√† N·ªôi, TP.HCM)" style="min-width:220px" list="addrList" />
      <datalist id="addrList"></datalist>
      <button id="btnSearch">T√¨m ki·∫øm</button>
      <span style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <span id="result-count" class="meta">ƒêang t·∫£i...</span>
      </span>
    </div>

    <section id="list" class="grid"></section>
  </main>
</div>

<script type="module">
  import { BASE_URL, API_BASE } from "../../assets/js/config.js";

  // ----------------- Guard + common helpers -----------------
  const authRaw = localStorage.getItem("auth");
  const auth = authRaw ? JSON.parse(authRaw) : null;
  const LOGIN_PAGE = BASE_URL + "interface/build/pages/UI_SignUp_TD-UV.html";
  if (!auth || !auth.ok || (auth.LoaiTaiKhoan && auth.LoaiTaiKhoan !== "UngVien")) {
    window.location.href = LOGIN_PAGE;
  }
  function getUVId(){
    return Number(auth?.MaUngVien ?? auth?.MaUV ?? auth?.MaTK ?? auth?.userId ?? auth?.id ?? 0);
  }
  const UV_EMAIL = auth?.email || auth?.Email || auth?.Email || "";

  // nav
  const nav = {
    home: BASE_URL + "interface/build/pages/UI_UV/uv-home.html",
    profile: BASE_URL + "interface/build/pages/UI_UV/uv-profile.html",
    apps: BASE_URL + "interface/build/pages/UI_UV/uv-my-applications.html",
  };
  document.getElementById("link-home").href = nav.home;
  document.getElementById("link-profile").href = nav.profile;
  document.getElementById("link-apps").href = nav.apps;
  document.getElementById("btn-logout").onclick = ()=>{
    localStorage.removeItem("auth");
    window.location.href = LOGIN_PAGE;
  };

  // show header info
  document.getElementById("uv-email").textContent = UV_EMAIL;
  document.getElementById("uv-initial").textContent = (UV_EMAIL||"UV").slice(0,2).toUpperCase();

  async function post(path, body={}){
    const res = await fetch(API_BASE + path, {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(body)});
    const data = await res.json().catch(()=>({ok:false,error:"Invalid JSON"}));
    if(!data.ok) throw new Error(data.error||"API error");
    return data;
  }

  // Locations for datalist
  async function loadLocations(){
    try{
      const r = await fetch(API_BASE + "API_list_DiaDiem.php").then(r=>r.json());
      const list = Array.isArray(r?.data)? r.data : [];
      const dl = document.getElementById("addrList"); dl.innerHTML = "";
      list.forEach(v => { const o = document.createElement("option"); o.value = v; dl.appendChild(o); });
    }catch{}
  }

  // Applied markers
  let appliedIds = new Set();
  let cancelledIds = new Set();
  async function loadApplied(){
    try{
      const r = await post("API_get_UngTuyen_ByUV_All.php",{ MaTK:getUVId(), MaUngVien:getUVId() });
      (r.data||[]).forEach(it => {
        if (it.TrangThai === 'Huy') {
          cancelledIds.add(Number(it.MaTin));
        } else {
          appliedIds.add(Number(it.MaTin));
        }
      });
    }catch{}
  }

  // Search + render
  async function search(){
    document.getElementById("result-count").textContent = "ƒêang t·∫£i...";
    const body = {
      keyword: document.getElementById("kw").value.trim(),
      diaDiem: document.getElementById("addr").value.trim(),
      MaTK: getUVId(),
      MaUngVien: getUVId()
    };
    const r = await post("API_search_TinTuyenDung.php", body);
    render(r.data||[]);
  }

  const listEl = document.getElementById("list");
  function render(items){
    document.getElementById("result-count").textContent = `${items.length} tin tuy·ªÉn d·ª•ng`;
    listEl.innerHTML = "";
    items.forEach(j=>{
      const applied = appliedIds.has(Number(j.MaTin));
      const cancelled = cancelledIds.has(Number(j.MaTin));
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div>
          <div style="font-weight:700">${j.TieuDe||""}</div>
          <div class="meta">${j.TenCongTy||""}</div>
          <div class="meta" style="margin-top:2px">${j.DiaDiem||""} ‚Ä¢ ${(j.LuongTu??"")} ${j.LuongTu!=null?"-":""} ${(j.LuongDen??"")}</div>
          ${j.MoTaNgan? `<div class="meta" style="margin-top:6px">${j.MoTaNgan}</div>`:""}
          <div class="tags">${(j.NganhNghe||"").split(",").filter(Boolean).map(x=>`<span class="tag">${x.trim()}</span>`).join("")}</div>
        </div>
        <div class="actions">
          <span class="badge ${applied?"applied":cancelled?"cancelled":""}" id="st-${j.MaTin}">
            ${cancelled ? "ƒê√£ h·ªßy" : applied ? "ƒê√£ ·ª©ng tuy·ªÉn" : "Ch∆∞a ·ª©ng tuy·ªÉn"}
          </span>
          <button class="btn primary" data-apply="${j.MaTin}" ${(applied||cancelled)?"style='display:none'":""}>·ª®ng tuy·ªÉn</button>
          <button class="btn" data-cancel="${j.MaTin}" ${applied?"":"style='display:none'"}>H·ªßy</button>
        </div>
      `;
      listEl.appendChild(card);
    });
  }

  listEl.addEventListener("click", async (e)=>{
    const apply = e.target.closest("[data-apply]");
    const cancel = e.target.closest("[data-cancel]");
    if(apply){
      const id = Number(apply.dataset.apply);
      try{
        const r = await post("API_apply_TinTuyenDung.php",{ MaTin:id, MaTK:getUVId(), MaUngVien:getUVId() });
        if(r.ok){
          // Reload applied data ƒë·ªÉ ƒë·∫£m b·∫£o ƒë·ªìng b·ªô
          await loadApplied();
          // Re-render ƒë·ªÉ c·∫≠p nh·∫≠t UI
          await search();
          alert("ƒê√£ ·ª©ng tuy·ªÉn th√†nh c√¥ng!");
        }
      }catch(err){ alert(err.message); }
    }
    if(cancel){
      const id = Number(cancel.dataset.cancel);
      try{
        const r = await post("API_cancel_UngTuyen.php",{ MaTin:id, MaTK:getUVId(), MaUngVien:getUVId() });
        if(r.ok){
          // Reload applied data ƒë·ªÉ ƒë·∫£m b·∫£o ƒë·ªìng b·ªô
          await loadApplied();
          // Re-render ƒë·ªÉ c·∫≠p nh·∫≠t UI
          await search();
          alert("ƒê√£ h·ªßy ·ª©ng tuy·ªÉn th√†nh c√¥ng!");
        }
      }catch(err){ alert(err.message); }
    }
  });

  // Init
  (async ()=>{
    await Promise.all([loadLocations(), loadApplied()]);
    await search();
    document.getElementById("btnSearch").onclick = search;
  })();
</script>
</body>
</html>
