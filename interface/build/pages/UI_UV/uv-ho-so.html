<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hồ sơ Ứng Viên</title>

  <link href="../../assets/css/nucleo-icons.css" rel="stylesheet" />
  <link href="../../assets/css/nucleo-svg.css" rel="stylesheet" />
  <link href="../../assets/css/argon-dashboard-tailwind.css?v=1.0.1" rel="stylesheet" />
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        referrerpolicy="no-referrer">
</head>

<body class="m-0 font-sans text-base antialiased leading-default bg-gray-50 text-slate-600">
  <div class="absolute w-full bg-blue-500 min-h-75"></div>

  <!-- Sidebar Placeholder -->
  <div id="uv-sidenav"></div>

  <script type="module">
      import { BASE_URL } from '../../assets/js/config.js';
      fetch(BASE_URL + "interface/build/pages/UI_UV/Sidenav_Ungvien.html")
          .then(r => r.text())
          .then(html => {
              document.getElementById("uv-sidenav").innerHTML = html;
          });
  </script>

  <main class="relative h-full max-h-screen xl:ml-68 rounded-xl">
    <nav class="relative flex items-center px-6 py-2 mx-6 rounded-2xl">
      <h6 class="mb-0 font-bold text-white">Hồ sơ Ứng Viên</h6>
    </nav>

    <div class="w-full px-6 py-6 mx-auto">
      <div class="bg-white rounded-2xl shadow-xl">
        <div class="p-6 pb-0 border-b flex flex-wrap gap-2 items-center">
          <button id="tab-view-btn" class="px-4 py-2 text-sm font-semibold rounded-lg bg-slate-100">Xem</button>
          <button id="tab-edit-btn" class="px-4 py-2 text-sm font-semibold rounded-lg border">Chỉnh sửa</button>
          <div class="ml-auto flex items-center gap-2 text-xs">
            <label for="inp-ma-uv" class="font-bold">Mã UV</label>
            <input id="inp-ma-uv" type="number" class="rounded-lg border px-3 py-2 min-w-[120px]" placeholder="#ID">
            <button id="btn-load" class="px-3 py-2 bg-blue-500 text-white rounded-lg">Tải</button>
          </div>
        </div>

        <!-- Tab Xem -->
        <div id="tab-view" class="p-6">
          <div id="profile-view" class="grid md:grid-cols-2 gap-4">
            <div class="h-4 bg-slate-200 rounded animate-pulse md:col-span-2"></div>
          </div>
        </div>

        <!-- Tab Chỉnh sửa -->
        <div id="tab-edit" class="p-6 hidden">
          <form id="form-edit" class="grid gap-4 md:grid-cols-2">
            <input type="hidden" name="MaUngVien" id="MaUngVien">

            <div>
              <label class="block text-xs font-bold mb-1">Họ tên</label>
              <input id="HoTen" name="HoTen" class="w-full rounded-lg border px-3 py-2" placeholder="Họ tên">
            </div>

            <div>
              <label class="block text-xs font-bold mb-1">Email</label>
              <div class="relative">
                <i class="fa-solid fa-envelope absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm"></i>
                <input id="Email" name="Email" class="w-full rounded-lg border pl-9 pr-3 py-2" placeholder="Email">
              </div>
            </div>

            <div>
              <label class="block text-xs font-bold mb-1">Số điện thoại</label>
              <div class="relative">
                <i class="fa-solid fa-phone absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm"></i>
                <input id="SoDienThoai" name="SoDienThoai" class="w-full rounded-lg border pl-9 pr-3 py-2" placeholder="SĐT">
              </div>
            </div>

            <div>
              <label class="block text-xs font-bold mb-1">Địa chỉ</label>
              <input id="DiaChi" name="DiaChi" class="w-full rounded-lg border px-3 py-2" placeholder="Địa chỉ">
            </div>

            <div class="md:col-span-2">
              <label class="block text-xs font-bold mb-1">Kỹ năng</label>
              <textarea id="KyNang" name="KyNang" class="w-full rounded-lg border px-3 py-2" rows="3" placeholder="Kỹ năng, công cụ…"></textarea>
            </div>

            <div class="md:col-span-2">
              <label class="block text-xs font-bold mb-1">Kinh nghiệm</label>
              <textarea id="KinhNghiem" name="KinhNghiem" class="w-full rounded-lg border px-3 py-2" rows="4" placeholder="Kinh nghiệm làm việc…"></textarea>
            </div>

            <div class="md:col-span-2 flex gap-2 pt-2">
              <button class="px-4 py-2 bg-blue-500 text-white rounded-lg text-sm font-semibold">Lưu</button>
              <button id="btn-cancel" type="button" class="px-4 py-2 bg-slate-100 rounded-lg text-sm font-semibold">Hủy</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    import { API_BASE, BASE_URL } from '../../assets/js/config.js';
    
    // Guard phiên
    const auth = JSON.parse(localStorage.getItem("auth") || "null");
    if (!auth?.ok || auth?.role !== "UngVien") {
        window.location.href = BASE_URL + "interface/build/pages/UI_SignUp_TD-UV.html";
    }
    
    const API_SHOW_UV   = `${API_BASE}API_show_UngVien.php`;
    const API_UPDATE_UV = `${API_BASE}API_update_Ungvien.php`;

    const tabView = document.getElementById('tab-view');
    const tabEdit = document.getElementById('tab-edit');
    document.getElementById('tab-view-btn').onclick = () => { tabView.classList.remove('hidden'); tabEdit.classList.add('hidden'); };
    document.getElementById('tab-edit-btn').onclick = () => { tabEdit.classList.remove('hidden'); tabView.classList.add('hidden'); };
    document.getElementById('btn-cancel').onclick   = () => { tabView.classList.remove('hidden'); tabEdit.classList.add('hidden'); };

    async function fetchJSON(url, options = {}) {
      const res  = await fetch(url, options);
      const text = await res.text();
      if (!res.ok) { alert(`HTTP ${res.status} @ ${url}\n\n${text.slice(0,300)}`); throw new Error(res.status); }
      const ct = res.headers.get('content-type') || '';
      if (!ct.includes('application/json')) { alert(`API không trả JSON @ ${url}\n\n${text.slice(0,300)}`); throw new Error('Not JSON'); }
      return JSON.parse(text);
    }

    function fillForm(data){
      const d = data || {};
      document.getElementById('MaUngVien').value  = d.MaUngVien || '';
      document.getElementById('HoTen').value      = d.HoTen || '';
      document.getElementById('Email').value      = d.Email || '';
      document.getElementById('SoDienThoai').value= d.SoDienThoai || d.SDT || '';
      document.getElementById('DiaChi').value     = d.DiaChi || '';
      document.getElementById('KyNang').value     = d.KyNang || '';
      document.getElementById('KinhNghiem').value = d.KinhNghiem || '';
    }

    function renderView(d){
      const wrap = document.getElementById('profile-view');
      if(!d){ wrap.innerHTML = `<div class="text-slate-400">Không có dữ liệu</div>`; return; }
      const ten  = d.HoTen || '-';
      const email= d.Email || '-';
      const sdt  = d.SoDienThoai || d.SDT || '-';
      const dc   = d.DiaChi || '-';
      const kn   = d.KyNang || '-';
      const exp  = d.KinhNghiem || '-';
      wrap.innerHTML = `
        <div class="p-5 rounded-xl border border-slate-200 bg-white/70 hover:shadow-lg transition md:col-span-2">
          <div class="flex items-center justify-between mb-3">
            <h6 class="font-extrabold text-lg text-slate-800">${ten}</h6>
            <span class="text-xs text-slate-400">MaUV: ${d.MaUngVien||'-'}</span>
          </div>
          <div class="grid md:grid-cols-2 gap-2 text-sm">
            <div class="flex items-center gap-2"><i class="fa-solid fa-envelope text-slate-400 w-4 text-center"></i><div><span class="text-slate-400">Email:</span> ${email}</div></div>
            <div class="flex items-center gap-2"><i class="fa-solid fa-phone text-slate-400 w-4 text-center"></i><div><span class="text-slate-400">SĐT:</span> ${sdt}</div></div>
            <div class="md:col-span-2 flex items-start gap-2"><i class="fa-solid fa-location-dot text-slate-400 w-4 text-center mt-0.5"></i><div><span class="text-slate-400">Địa chỉ:</span> ${dc}</div></div>
            <div class="md:col-span-2"><div class="text-slate-400">Kỹ năng:</div><div class="mt-1 whitespace-pre-line">${kn}</div></div>
            <div class="md:col-span-2"><div class="text-slate-400">Kinh nghiệm:</div><div class="mt-1 whitespace-pre-line">${exp}</div></div>
          </div>
        </div>`;
    }

    async function loadUV(){
      const id = document.getElementById('inp-ma-uv').value.trim();
      if(!id){ alert('Nhập Mã Ứng Viên'); return; }
      document.getElementById('profile-view').innerHTML = `<div class=\"text-slate-400\">Đang tải…</div>`;
      try{
        // Thử với MaUngVien trước, nếu không được thì dùng MaTK
        const js = await fetchJSON(`${API_SHOW_UV}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ MaUngVien: id })
        });
        if (js.ok && js.data) {
          fillForm(js.data);
          renderView(js.data);
        } else {
          // Thử với MaTK nếu MaUngVien không được
          const js2 = await fetchJSON(`${API_SHOW_UV}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ MaTK: id })
          });
          if (js2.ok && js2.data) {
            fillForm(js2.data);
            renderView(js2.data);
          } else {
            document.getElementById('profile-view').innerHTML = `<div class=\"text-red-500\">${js2.error || 'Không tìm thấy dữ liệu'}</div>`;
          }
        }
      }catch(e){
        console.error(e);
        document.getElementById('profile-view').innerHTML = `<div class=\"text-red-500\">Lỗi tải dữ liệu</div>`;
      }
    }

    async function saveUV(e){
      e.preventDefault();
      // Chỉ gửi đúng các trường API_update_Ungvien.php hỗ trợ
      const fd = new FormData();
      fd.append('MaUngVien', document.getElementById('MaUngVien').value);
      const HoTen        = document.getElementById('HoTen').value.trim();
      const SoDienThoai  = document.getElementById('SoDienThoai').value.trim();
      const KyNang       = document.getElementById('KyNang').value.trim();
      const KinhNghiem   = document.getElementById('KinhNghiem').value.trim();
      if(HoTen)       fd.append('HoTen', HoTen);
      if(SoDienThoai) fd.append('SoDienThoai', SoDienThoai);
      if(KyNang)      fd.append('KyNang', KyNang);
      if(KinhNghiem)  fd.append('KinhNghiem', KinhNghiem);
      try{
        const js = await fetchJSON(API_UPDATE_UV,{ method:'POST', body: fd });
        if(js.status==='success'){
          alert('Cập nhật thành công');
          tabView.classList.remove('hidden'); tabEdit.classList.add('hidden');
          loadUV();
        }else{
          alert(js.message||'Cập nhật thất bại');
        }
      }catch(e){
        console.error(e);
        alert('Lỗi API');
      }
    }

    document.getElementById('btn-load').addEventListener('click', loadUV);
    document.getElementById('form-edit').addEventListener('submit', saveUV);
  </script>

  <script src="../../assets/js/plugins/perfect-scrollbar.min.js" async></script>
  <script src="../../assets/js/argon-dashboard-tailwind.js?v=1.0.1" async></script>
</body>
</html>


