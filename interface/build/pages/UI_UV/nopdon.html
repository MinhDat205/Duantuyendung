<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fidovn - Nộp đơn ứng tuyển</title>
    <!-- Font Awesome Icons -->
    <script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'fido-orange': '#FF6B35',
                        'fido-dark': '#2D3748'
                    }
                }
            }
        }
    </script>
    <style>
        .sidebar-item.is-active {
            background-color: #FF6B35 !important;
            color: white !important;
        }
        .sidebar-item:hover {
            background-color: #f3f4f6;
        }
        .form-input {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.75rem;
            width: 100%;
            transition: all 0.2s;
        }
        .form-input:focus {
            outline: none;
            border-color: #FF6B35;
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }
        .btn-primary {
            background-color: #FF6B35;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary:hover {
            background-color: #e55a2b;
        }
        .btn-primary:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        .btn-secondary {
            background-color: #6b7280;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        .toast {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            color: white;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        .toast.show {
            transform: translateX(0);
        }
        .toast.success {
            background-color: #10b981;
        }
        .toast.error {
            background-color: #ef4444;
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #FF6B35;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Toast Container -->
    <div id="toast" class="toast"></div>

    <!-- Header -->
    <header class="bg-fido-dark text-white shadow-lg">
        <div class="container mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-white">Fidovn</h1>
                </div>
                <nav class="hidden md:flex items-center space-x-8">
                    <a href="main.html" class="flex items-center space-x-2 hover:text-fido-orange transition-colors">
                        <i class="fas fa-home"></i>
                        <span>Trang chủ</span>
                    </a>
                    <a href="vieclam.html" class="flex items-center space-x-2 hover:text-fido-orange transition-colors">
                        <i class="fas fa-briefcase"></i>
                        <span>Việc làm</span>
                    </a>
                    <a href="#" class="flex items-center space-x-2 hover:text-fido-orange transition-colors">
                        <i class="fas fa-building"></i>
                        <span>Công ty</span>
                    </a>
                </nav>
                <div class="flex items-center space-x-4">
                    <button class="p-2 hover:bg-gray-700 rounded-lg transition-colors">
                        <i class="fas fa-user-circle text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Breadcrumbs -->
    <div class="bg-white border-b">
        <div class="container mx-auto px-4 py-2">
            <nav class="text-sm text-gray-600">
                <a href="main.html" class="hover:text-fido-orange">Trang chủ</a>
                <span class="mx-2">/</span>
                <a href="vieclam.html" class="hover:text-fido-orange">Việc làm</a>
                <span class="mx-2">/</span>
                <span>Nộp đơn ứng tuyển</span>
            </nav>
        </div>
    </div>

    <div class="flex min-h-screen bg-gray-50">
        <!-- Sidebar Left (280px) -->
        <aside id="uv-sidebar" class="w-70 bg-white shadow-lg">
            <div class="p-6">
                <!-- Profile Brief Card -->
                <div class="uv-brief-card bg-orange-500 rounded-lg p-4 mb-6">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center mr-3">
                            <span class="text-white font-bold text-lg">T</span>
                        </div>
                        <div class="flex-1">
                            <h4 class="text-white font-semibold">Thắng Trương Văn</h4>
                            <p class="text-white text-sm opacity-90">ID: #45824901</p>
                            <p class="text-white text-sm opacity-90">thangtv5280@ut.edu.vn</p>
                        </div>
                    </div>
                </div>

                <!-- Navigation Menu -->
                <nav class="space-y-2">
                    <a href="dashboard.html" class="sidebar-item flex items-center space-x-3 p-3 rounded-lg text-gray-700 hover:bg-gray-100">
                        <i class="fas fa-tv text-blue-500"></i>
                        <span>Tổng quan</span>
                    </a>
                    <a href="thong-tin-ca-nhan.html" class="sidebar-item flex items-center space-x-3 p-3 rounded-lg text-gray-700 hover:bg-gray-100">
                        <i class="fas fa-user text-orange-500"></i>
                        <span>Thông tin cá nhân</span>
                    </a>
                    <a href="quan-ly-cv.html" class="sidebar-item flex items-center space-x-3 p-3 rounded-lg text-gray-700 hover:bg-gray-100">
                        <i class="fas fa-file-alt text-emerald-500"></i>
                        <span>Quản lý CV</span>
                    </a>
                    <a href="vieclam.html" class="sidebar-item is-active flex items-center space-x-3 p-3 rounded-lg">
                        <i class="fas fa-briefcase text-cyan-500"></i>
                        <span>Quản lý việc làm</span>
                    </a>
                    <a href="ung-tuyen-cua-toi.html" class="sidebar-item flex items-center space-x-3 p-3 rounded-lg text-gray-700 hover:bg-gray-100">
                        <i class="fas fa-paper-plane text-purple-500"></i>
                        <span>Ứng tuyển của tôi</span>
                    </a>
                    <a href="tin-da-luu.html" class="sidebar-item flex items-center space-x-3 p-3 rounded-lg text-gray-700 hover:bg-gray-100">
                        <i class="fas fa-bookmark text-yellow-500"></i>
                        <span>Tin đã lưu</span>
                    </a>
                    <a href="lich-phong-van.html" class="sidebar-item flex items-center space-x-3 p-3 rounded-lg text-gray-700 hover:bg-gray-100">
                        <i class="fas fa-calendar text-pink-500"></i>
                        <span>Lịch phỏng vấn</span>
                    </a>
                    <a href="theo-doi.html" class="sidebar-item flex items-center space-x-3 p-3 rounded-lg text-gray-700 hover:bg-gray-100">
                        <i class="fas fa-heart text-red-500"></i>
                        <span>Theo dõi</span>
                    </a>
                    <a href="profile.html" class="sidebar-item flex items-center space-x-3 p-3 rounded-lg text-gray-700 hover:bg-gray-100">
                        <i class="fas fa-cog text-gray-500"></i>
                        <span>Quản lý tài khoản</span>
                    </a>
                </nav>
            </div>
        </aside>

        <!-- Main Content Right (flex 1) -->
        <main class="flex-1 p-8">
            <div class="max-w-4xl mx-auto">
                <h1 class="text-3xl font-bold text-gray-800 mb-8">Nộp đơn ứng tuyển</h1>
                
                <!-- Job Summary -->
                <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Thông tin việc làm</h2>
                    
                    <div id="jobSummary" class="space-y-4">
                        <!-- Job info will be loaded here -->
                    </div>
                </div>

                <!-- Application Form -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-6">Đơn ứng tuyển</h2>
                    
                    <form id="applicationForm" class="space-y-6">
                        <!-- CV Selection -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Chọn CV <span class="text-red-500">*</span>
                            </label>
                            <select id="cvSelect" name="cv_id" class="form-input" required>
                                <option value="">Chọn CV để nộp</option>
                                <!-- CV options will be loaded here -->
                            </select>
                            <p class="text-sm text-gray-500 mt-1">Vui lòng chọn CV phù hợp nhất với vị trí này</p>
                        </div>

                        <!-- Cover Letter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Thư xin việc
                            </label>
                            <textarea id="coverLetter" name="cover_letter" rows="6" 
                                      class="form-input" 
                                      placeholder="Viết thư xin việc để giới thiệu bản thân và lý do ứng tuyển..."></textarea>
                            <p class="text-sm text-gray-500 mt-1">Thư xin việc sẽ giúp nhà tuyển dụng hiểu rõ hơn về bạn</p>
                        </div>

                        <!-- Additional Questions -->
                        <div id="additionalQuestions">
                            <!-- Additional questions will be loaded here if any -->
                        </div>

                        <!-- Terms and Conditions -->
                        <div class="flex items-start space-x-3">
                            <input type="checkbox" id="agreeTerms" name="agree_terms" class="mt-1" required>
                            <label for="agreeTerms" class="text-sm text-gray-700">
                                Tôi đồng ý với <a href="#" class="text-fido-orange hover:underline">điều khoản sử dụng</a> và 
                                <a href="#" class="text-fido-orange hover:underline">chính sách bảo mật</a> của Fidovn
                            </label>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" class="btn-secondary" onclick="goBack()">Quay lại</button>
                            <button type="submit" id="submitBtn" class="btn-primary">
                                <span class="spinner hidden"></span>
                                <span>Xác nhận nộp đơn</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script>
        let currentJob = null;
        let userCVs = [];

        // Get job ID from URL
        function getJobId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('job_id');
        }

        // Load job information
        async function loadJobInfo() {
            const jobId = getJobId();
            if (!jobId) {
                showError('Không tìm thấy ID việc làm');
                return;
            }

            try {
                const response = await fetch(`../../API/jobs/detail.php?id=${jobId}`);
                const data = await response.json();
                
                if (data.ok) {
                    currentJob = data.data;
                    displayJobSummary(currentJob);
                } else {
                    showError('Không thể tải thông tin việc làm');
                }
            } catch (error) {
                console.error('Error loading job info:', error);
                // For demo purposes, load mock data
                loadMockJobData();
            }
        }

        // Load mock job data for demonstration
        function loadMockJobData() {
            const mockJob = {
                id: getJobId() || 1,
                title: "CHUYÊN VIÊN DIGITAL MARKETING",
                salary: "15 triệu - 25 triệu /tháng",
                location: "Hồ Chí Minh, Quận 1",
                type: "Toàn thời gian",
                company: "CÔNG TY TNHH DIGITAL SOLUTIONS",
                logo: "DIGITAL",
                postedDate: "2 ngày trước",
                experience: "2-5 năm",
                education: "Đại học"
            };

            currentJob = mockJob;
            displayJobSummary(mockJob);
        }

        // Display job summary
        function displayJobSummary(job) {
            const container = document.getElementById('jobSummary');
            
            container.innerHTML = `
                <div class="flex items-start space-x-4">
                    <div class="w-16 h-16 bg-gray-200 rounded-lg flex items-center justify-center">
                        <span class="text-xl font-bold text-gray-600">${job.logo.substring(0, 1)}</span>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">${job.title}</h3>
                        <p class="text-fido-orange font-medium mb-2">${job.salary}</p>
                        <div class="grid grid-cols-2 gap-4 text-sm text-gray-600">
                            <div>
                                <span class="font-medium">Công ty:</span> ${job.company}
                            </div>
                            <div>
                                <span class="font-medium">Địa điểm:</span> ${job.location}
                            </div>
                            <div>
                                <span class="font-medium">Hình thức:</span> ${job.type}
                            </div>
                            <div>
                                <span class="font-medium">Kinh nghiệm:</span> ${job.experience}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Load user CVs
        async function loadUserCVs() {
            try {
                const response = await fetch('../../API/ungvien/cv-list.php');
                const data = await response.json();
                
                if (data.ok) {
                    userCVs = data.data;
                    populateCVSelect(userCVs);
                } else {
                    showToast('Không thể tải danh sách CV', 'error');
                }
            } catch (error) {
                console.error('Error loading CVs:', error);
                // For demo purposes, load mock CVs
                loadMockCVs();
            }
        }

        // Load mock CVs for demonstration
        function loadMockCVs() {
            const mockCVs = [
                { id: 1, name: "CV Developer Fullstack", is_default: true, updated_at: "2024-01-15" },
                { id: 2, name: "CV Marketing Digital", is_default: false, updated_at: "2024-01-10" },
                { id: 3, name: "CV Sales Executive", is_default: false, updated_at: "2024-01-05" }
            ];

            userCVs = mockCVs;
            populateCVSelect(mockCVs);
        }

        // Populate CV select dropdown
        function populateCVSelect(cvs) {
            const select = document.getElementById('cvSelect');
            select.innerHTML = '<option value="">Chọn CV để nộp</option>';
            
            cvs.forEach(cv => {
                const option = document.createElement('option');
                option.value = cv.id;
                option.textContent = `${cv.name} ${cv.is_default ? '(Mặc định)' : ''}`;
                select.appendChild(option);
            });
        }

        // Load additional questions if any
        async function loadAdditionalQuestions() {
            try {
                const jobId = getJobId();
                const response = await fetch(`../../API/jobs/questions.php?id=${jobId}`);
                const data = await response.json();
                
                if (data.ok && data.data.length > 0) {
                    displayAdditionalQuestions(data.data);
                }
            } catch (error) {
                console.error('Error loading additional questions:', error);
            }
        }

        // Display additional questions
        function displayAdditionalQuestions(questions) {
            const container = document.getElementById('additionalQuestions');
            
            const questionsHTML = questions.map((q, index) => `
                <div class="border-t pt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        ${q.question} ${q.required ? '<span class="text-red-500">*</span>' : ''}
                    </label>
                    ${q.type === 'text' ? 
                        `<input type="text" name="question_${q.id}" class="form-input" ${q.required ? 'required' : ''}>` :
                        `<textarea name="question_${q.id}" rows="3" class="form-input" ${q.required ? 'required' : ''}></textarea>`
                    }
                </div>
            `).join('');
            
            container.innerHTML = questionsHTML;
        }

        // Form submission
        document.getElementById('applicationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Validate form
            if (!validateForm()) {
                return;
            }

            // Show loading state
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.classList.add('loading');
            submitBtn.querySelector('.spinner').classList.remove('hidden');

            try {
                const formData = new FormData(this);
                const body = Object.fromEntries(formData.entries());
                
                // Add job ID
                body.job_id = getJobId();

                const response = await fetch('../../API/ungvien/apply.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(body)
                });

                const result = await response.json();
                
                if (result.ok) {
                    showSuccess();
                } else {
                    showToast(result.message || 'Có lỗi xảy ra khi nộp đơn', 'error');
                }
            } catch (error) {
                console.error('Error submitting application:', error);
                showToast('Có lỗi xảy ra khi nộp đơn', 'error');
            } finally {
                // Hide loading state
                submitBtn.disabled = false;
                submitBtn.classList.remove('loading');
                submitBtn.querySelector('.spinner').classList.add('hidden');
            }
        });

        // Validate form
        function validateForm() {
            const cvSelect = document.getElementById('cvSelect');
            const agreeTerms = document.getElementById('agreeTerms');
            
            if (!cvSelect.value) {
                showToast('Vui lòng chọn CV để nộp', 'error');
                cvSelect.focus();
                return false;
            }
            
            if (!agreeTerms.checked) {
                showToast('Vui lòng đồng ý với điều khoản sử dụng', 'error');
                agreeTerms.focus();
                return false;
            }
            
            return true;
        }

        // Show success message
        function showSuccess() {
            const mainContent = document.querySelector('main');
            mainContent.innerHTML = `
                <div class="max-w-2xl mx-auto text-center py-16">
                    <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-check text-4xl text-green-600"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">Nộp đơn thành công!</h2>
                    <p class="text-gray-600 mb-8">Đơn ứng tuyển của bạn đã được gửi thành công. Chúng tôi sẽ thông báo kết quả sớm nhất.</p>
                    
                    <div class="space-y-4">
                        <a href="ung-tuyen-cua-toi.html" class="inline-block bg-fido-orange text-white px-8 py-3 rounded-lg font-semibold hover:bg-orange-600 transition-colors">
                            Xem đơn ứng tuyển của tôi
                        </a>
                        <br>
                        <a href="vieclam.html" class="inline-block bg-gray-500 text-white px-8 py-3 rounded-lg font-semibold hover:bg-gray-600 transition-colors">
                            Tìm việc làm khác
                        </a>
                    </div>
                </div>
            `;
        }

        // Go back
        function goBack() {
            if (currentJob) {
                window.location.href = `vieclam-chi-tiet.html?id=${currentJob.id}`;
            } else {
                window.location.href = 'vieclam.html';
            }
        }

        // Show toast message
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Show error message
        function showError(message) {
            const mainContent = document.querySelector('main');
            mainContent.innerHTML = `
                <div class="flex items-center justify-center min-h-screen">
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle text-6xl text-red-500 mb-4"></i>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Có lỗi xảy ra</h2>
                        <p class="text-gray-600 mb-4">${message}</p>
                        <a href="vieclam.html" class="inline-block bg-fido-orange text-white px-6 py-3 rounded-lg font-semibold hover:bg-orange-600 transition-colors">
                            Quay lại danh sách việc làm
                        </a>
                    </div>
                </div>
            `;
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadJobInfo();
            loadUserCVs();
            loadAdditionalQuestions();
        });
    </script>
</body>
</html>
