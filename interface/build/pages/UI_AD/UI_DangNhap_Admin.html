<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Đăng nhập Quản trị viên</title>

    <!-- Nếu đã đăng nhập thì vào Trang chủ -->
    <script>
      (function () {
        const params = new URLSearchParams(window.location.search);
        if (params.get("logged_out") === "1") {
          try {
            localStorage.removeItem("admin_logged_in");
            localStorage.removeItem("admin_email");
            sessionStorage.removeItem("navInApp");
            sessionStorage.removeItem("skipCloseLogoutOnce");
          } catch (e) {}
          params.delete("logged_out");
          const url =
            window.location.pathname +
            (params.toString() ? "?" + params.toString() : "");
          window.history.replaceState({}, "", url);
          return;
        }
        if (localStorage.getItem("admin_logged_in") === "true") {
          window.location.href = "UI_Admin_Trangchu.html";
        }
      })();
    </script>

    <!-- Fonts & Icons -->
    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700"
      rel="stylesheet"
    />
    <script
      src="https://kit.fontawesome.com/42d5adcbca.js"
      crossorigin="anonymous"
    ></script>

    <!-- Argon CSS -->
    <link href="../../assets/css/nucleo-icons.css" rel="stylesheet" />
    <link href="../../assets/css/nucleo-svg.css" rel="stylesheet" />
    <link
      href="../../assets/css/argon-dashboard-tailwind.css?v=1.0.1"
      rel="stylesheet"
    />
    <link
      rel="apple-touch-icon"
      sizes="76x76"
      href="../../assets/img/apple-icon.png"
    />
    <link rel="icon" type="image/png" href="../../assets/img/favicon.png" />
  </head>

  <body class="bg-gray-100">
    <main class="mt-0 transition-all duration-200 ease-in-out">
      <section class="min-h-screen">
        <div
          class="relative flex items-start pt-12 pb-56 m-4 overflow-hidden bg-cover min-h-50-screen rounded-xl bg-[url('https://raw.githubusercontent.com/creativetimofficial/public-assets/master/argon-dashboard-pro/assets/img/signup-cover.jpg')]"
        >
          <span
            class="absolute top-0 left-0 w-full h-full bg-gradient-to-tl from-gray-800 to-gray-700 opacity-60"
          ></span>
          <div class="container z-10">
            <div class="flex flex-wrap justify-center -mx-3">
              <div
                class="w-full max-w-full px-3 mx-auto mt-0 text-center lg:w-5/12"
              >
                <h1 class="mt-12 mb-2 text-white">Quản trị viên</h1>
                <p class="text-white">
                  Vui lòng đăng nhập để truy cập hệ thống
                </p>
              </div>
            </div>
          </div>
        </div>

        <div class="container">
          <div class="flex flex-wrap -mx-3 -mt-48 md:-mt-56 lg:-mt-48">
            <div
              class="w-full max-w-full px-3 mx-auto md:w-7/12 lg:w-5/12 xl:w-4/12"
            >
              <div
                class="relative flex flex-col min-w-0 break-words bg-white border-0 shadow-xl rounded-2xl"
              >
                <div
                  class="p-6 mb-0 text-center bg-white border-b-0 rounded-t-2xl"
                >
                  <h5>Đăng nhập</h5>
                </div>
                <div class="flex-auto p-6">
                  <form id="loginForm">
                    <input
                      type="hidden"
                      name="redirect"
                      value="/Duantuyendung/interface/build/pages/UI_AD/UI_Admin_Trangchu.html"
                    />
                    <div class="mb-4">
                      <input
                        type="email"
                        name="Email"
                        required
                        autocomplete="username"
                        class="placeholder:text-gray-500 text-sm block w-full rounded-lg border border-gray-300 py-2 px-3 focus:border-blue-500 focus:outline-none"
                        placeholder="Email quản trị viên"
                      />
                    </div>
                    <div class="mb-1">
                      <input
                        type="password"
                        name="MatKhau"
                        required
                        autocomplete="current-password"
                        class="placeholder:text-gray-500 text-sm block w-full rounded-lg border border-gray-300 py-2 px-3 focus:border-blue-500 focus:outline-none"
                        placeholder="Mật khẩu"
                      />
                    </div>
                    <p
                      id="loginError"
                      class="text-rose-600 text-xs mt-2 hidden"
                    ></p>
                    <div class="text-center">
                      <button
                        id="btnSubmit"
                        type="submit"
                        class="inline-block w-full px-5 py-2.5 mt-6 font-bold text-white rounded-lg shadow-md bg-gradient-to-tl from-zinc-800 to-zinc-700 hover:opacity-90"
                      >
                        Đăng nhập
                      </button>
                    </div>
                  </form>
                  <p class="mt-4 text-xs text-slate-400 text-center">
                    API: <code>../../../API/API_login_Admin.php</code>
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <script>
      const API_LOGIN = "../../../API/API_login_Admin.php";

      function toFormData(obj) {
        const fd = new URLSearchParams();
        Object.entries(obj).forEach(([k, v]) => fd.append(k, v));
        return fd;
      }

      document
        .getElementById("loginForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const form = e.target;
          const Email = form.Email.value.trim();
          const MatKhau = form.MatKhau.value.trim();
          const redirect = form.querySelector('input[name="redirect"]').value;

          const errEl = document.getElementById("loginError");
          const btn = document.getElementById("btnSubmit");
          errEl.classList.add("hidden");
          errEl.textContent = "";

          btn.disabled = true;
          btn.style.opacity = "0.7";

          try {
            const res = await fetch(API_LOGIN, {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: toFormData({ Email, MatKhau, redirect, return_json: "1" }),
            });

            let data = null;
            try {
              data = await res.json();
            } catch {
              throw new Error("Máy chủ trả về dữ liệu không hợp lệ");
            }

            if (!res.ok || data.status !== "success") {
              throw new Error((data && data.message) || "Đăng nhập thất bại");
            }

            localStorage.setItem("admin_logged_in", "true");
            localStorage.setItem("admin_email", Email);

            // Đánh dấu điều hướng nội bộ để (nếu có auto-logout) không hiểu nhầm là đóng tab
            try {
              sessionStorage.setItem("navInApp", "1");
            } catch {}

            window.location.href =
              data.redirect || redirect || "UI_Admin_Trangchu.html";
          } catch (err) {
            errEl.textContent = err.message || "Có lỗi xảy ra";
            errEl.classList.remove("hidden");
          } finally {
            btn.disabled = false;
            btn.style.opacity = "1";
          }
        });
    </script>
  </body>
</html>
