<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="apple-touch-icon"
      sizes="76x76"
      href="../assets/img/apple-icon.png"
    />
    <link rel="icon" type="image/png" href="../assets/img/favicon.png" />
    <title>Đăng ký / Đăng nhập - Duantuyendung</title>

    <!-- Fonts & Icons -->
    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700"
      rel="stylesheet"
    />
    <script
      src="https://kit.fontawesome.com/42d5adcbca.js"
      crossorigin="anonymous"
    ></script>
    <link href="../assets/css/nucleo-icons.css" rel="stylesheet" />
    <link href="../assets/css/nucleo-svg.css" rel="stylesheet" />
    <!-- Argon Tailwind -->
    <link
      href="../assets/css/argon-dashboard-tailwind.css?v=1.0.1"
      rel="stylesheet"
    />

    <style>
      .tab-btn.active {
        opacity: 1;
        filter: none;
      }
      .tab-btn:not(.active) {
        opacity: 0.6;
      }
      .hidden {
        display: none;
      }
      .chip {
        display: inline-block;
        padding: 6px 10px;
        border: 1px solid #d1d5db;
        border-radius: 999px;
        margin: 4px;
        font-size: 12px;
        cursor: pointer;
        user-select: none;
      }
      .chip.selected {
        background: #111827;
        color: #fff;
        border-color: #111827;
      }
      .chip-small {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 8px;
        border-radius: 999px;
        background: #111827;
        color: #fff;
        font-size: 12px;
      }
      .chip-x {
        cursor: pointer;
        opacity: 0.85;
      }
      .input {
        width: 100%;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        padding: 0.5rem 0.75rem;
        font-size: 0.9rem;
      }
      .btn-primary {
        display: inline-block;
        width: 100%;
        padding: 0.6rem 1rem;
        border-radius: 0.5rem;
        color: #fff;
        background: linear-gradient(45deg, #27272a, #3f3f46);
        font-weight: 700;
        font-size: 0.9rem;
      }
      .btn-primary:hover {
        filter: brightness(1.03);
        transform: translateY(-1px);
      }
      .btn {
        padding: 0.55rem 0.9rem;
        border-radius: 10px;
        font-weight: 700;
        font-size: 0.9rem;
      }
      .btn-outline {
        border: 1px solid #d1d5db;
        color: #111827;
        background: #fff;
      }
      .btn-outline:hover {
        background: #f8fafc;
      }
      .btn-primary-sm {
        background: linear-gradient(45deg, #27272a, #3f3f46);
        color: #fff;
      }
      .msg {
        margin-top: 0.5rem;
        font-size: 0.875rem;
      }
      .muted {
        color: #6b7280;
        font-size: 0.85rem;
      }
      .preview {
        width: 100%;
        max-height: 200px;
        object-fit: contain;
        border: 1px dashed #e5e7eb;
        border-radius: 0.5rem;
        padding: 8px;
        background: #fafafa;
      }
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        display: none;
        z-index: 9998;
      }
      .modal {
        position: fixed;
        inset: 0;
        display: none;
        z-index: 9999;
        align-items: center;
        justify-content: center;
      }
      .modal.open {
        display: flex;
      }
      .modal-backdrop.open {
        display: block;
      }
      .modal-card {
        width: 100%;
        max-width: 720px;
        background: #fff;
        border-radius: 14px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
      }
      .modal-header {
        padding: 14px 16px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .modal-title {
        font-weight: 700;
        font-size: 16px;
      }
      .modal-body {
        padding: 14px 16px;
      }
      .modal-footer {
        padding: 12px 16px;
        border-top: 1px solid #e5e7eb;
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }
      .search-input {
        width: 100%;
        border: 1px solid #d1d5db;
        border-radius: 10px;
        padding: 0.55rem 0.75rem;
        font-size: 0.95rem;
      }
      .toolbar {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
        margin-top: 8px;
        margin-bottom: 10px;
      }
      .cat-list {
        max-height: 380px;
        overflow: auto;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 8px;
        background: #fafafa;
      }
      .cat-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 10px;
        border-radius: 10px;
      }
      .cat-item:hover {
        background: #f1f5f9;
      }
    </style>
  </head>
  <body
    class="m-0 font-sans antialiased font-normal bg-white text-start text-base leading-default text-slate-500"
  >
    <!-- Navbar -->
    <nav
      class="absolute top-0 z-30 flex flex-wrap items-center justify-between w-full px-4 py-2 mt-6 mb-4 shadow-none lg:flex-nowrap lg:justify-start"
    >
      <div
        class="container flex items-center justify-between py-0 flex-wrap-inherit"
      >
        <span
          class="py-1.75 ml-4 mr-4 font-bold text-white text-sm whitespace-nowrap lg:ml-0"
          >Duantuyendung</span
        >
      </div>
    </nav>

    <main class="mt-0 transition-all duration-200 ease-in-out">
      <section class="min-h-screen">
        <div
          class="bg-top relative flex items-start pt-12 pb-56 m-4 overflow-hidden bg-cover min-h-50-screen rounded-xl bg-[url('https://raw.githubusercontent.com/creativetimofficial/public-assets/master/argon-dashboard-pro/assets/img/signup-cover.jpg')]"
        >
          <span
            class="absolute top-0 left-0 w-full h-full bg-center bg-cover bg-gradient-to-tl from-zinc-800 to-zinc-700 opacity-60"
          ></span>
          <div class="container z-10">
            <div class="flex flex-wrap justify-center -mx-3">
              <div
                class="w-full max-w-full px-3 mx-auto mt-0 text-center lg:flex-0 shrink-0 lg:w-5/12"
              >
                <h1 class="mt-12 mb-2 text-white">Chào bạn!</h1>
                <p class="text-white">
                  Tạo tài khoản mới hoặc đăng nhập để bắt đầu.
                </p>
              </div>
            </div>
          </div>
        </div>

        <div class="container">
          <div class="flex flex-wrap -mx-3 -mt-48 md:-mt-56 lg:-mt-48">
            <div
              class="w-full max-w-full px-3 mx-auto mt-0 md:flex-0 shrink-0 md:w-7/12 lg:w-5/12 xl:w-4/12"
            >
              <div
                class="relative z-0 flex flex-col min-w-0 break-words bg-white border-0 shadow-xl rounded-2xl bg-clip-border"
              >
                <!-- Tabs -->
                <div
                  class="p-6 pb-0 text-center bg-white border-b-0 rounded-t-2xl"
                >
                  <div class="flex justify-center gap-3">
                    <button
                      id="btnTabSignup"
                      class="tab-btn active inline-block px-5 py-2.5 font-bold text-center text-white align-middle bg-gradient-to-tl from-zinc-800 to-zinc-700 rounded-lg text-sm"
                    >
                      Đăng ký
                    </button>
                    <button
                      id="btnTabSignin"
                      class="tab-btn inline-block px-5 py-2.5 font-bold text-center text-slate-700 align-middle bg-gray-100 rounded-lg text-sm"
                    >
                      Đăng nhập
                    </button>
                  </div>
                </div>

                <!-- Đăng ký -->
                <div id="tabSignup" class="flex-auto p-6">
                  <form id="formSignup">
                    <div class="mb-3">
                      <label class="text-sm font-semibold">Bạn là</label>
                      <div class="flex gap-4 mt-2">
                        <label class="text-sm"
                          ><input
                            type="radio"
                            name="loaiTaiKhoan"
                            value="UngVien"
                            checked
                          />
                          Ứng viên</label
                        >
                        <label class="text-sm"
                          ><input
                            type="radio"
                            name="loaiTaiKhoan"
                            value="NhaTuyenDung"
                          />
                          Nhà tuyển dụng</label
                        >
                      </div>
                    </div>

                    <!-- Ứng viên -->
                    <div id="uvFields">
                      <div class="mb-3">
                        <input
                          id="uvHoTen"
                          type="text"
                          class="input"
                          placeholder="Họ tên (Ứng viên)"
                        />
                      </div>
                      <div class="mb-3">
                        <input
                          id="uvSoDienThoai"
                          type="text"
                          class="input"
                          placeholder="Số điện thoại (tuỳ chọn)"
                        />
                      </div>
                      <div class="mb-3">
                        <label class="text-sm font-semibold block mb-1"
                          >Ảnh CV (tuỳ chọn)</label
                        >
                        <input
                          id="uvAnhCV"
                          type="file"
                          accept="image/*"
                          class="input"
                        />
                        <small class="text-xs text-slate-400"
                          >Hỗ trợ: JPG/PNG/WebP/GIF, tối đa 5MB.</small
                        >
                        <div id="cvPreviewWrap" class="mt-2 hidden">
                          <img
                            id="cvPreview"
                            class="preview"
                            alt="Xem trước ảnh CV"
                          />
                        </div>
                        <div id="cvMsg" class="msg"></div>
                      </div>
                    </div>

                    <!-- Nhà tuyển dụng -->
                    <div id="ntdFields" class="hidden">
                      <div class="mb-3">
                        <input
                          id="ntdTenCongTy"
                          type="text"
                          class="input"
                          placeholder="Tên công ty"
                        />
                      </div>
                      <div class="mb-3">
                        <input
                          id="ntdSoDienThoai"
                          type="text"
                          class="input"
                          placeholder="Số điện thoại (tuỳ chọn)"
                        />
                      </div>
                      <div class="mb-3">
                        <input
                          id="ntdDiaChi"
                          type="text"
                          class="input"
                          placeholder="Địa chỉ (tuỳ chọn)"
                        />
                      </div>
                    </div>

                    <div class="mb-3">
                      <input
                        id="email"
                        type="email"
                        class="input"
                        placeholder="Email"
                      />
                    </div>
                    <div class="mb-3">
                      <input
                        id="password"
                        type="password"
                        class="input"
                        placeholder="Mật khẩu"
                      />
                    </div>

                    <!-- Ngành nghề -->
                    <div class="mb-3">
                      <label class="text-sm font-semibold block mb-1"
                        >Ngành nghề (nhiều)</label
                      >
                      <div class="flex items-center gap-8 flex-wrap">
                        <button
                          type="button"
                          id="btnOpenCats"
                          class="btn btn-outline"
                        >
                          Chọn ngành nghề
                        </button>
                        <div
                          id="selectedChips"
                          class="flex flex-wrap gap-2"
                        ></div>
                      </div>
                      <p class="text-xs text-slate-400 mt-2">
                        Nhấn “Chọn ngành nghề” để tìm và chọn nhanh.
                      </p>
                    </div>

                    <button type="submit" class="btn-primary mt-2">
                      Tạo tài khoản
                    </button>
                    <div id="signupMsg" class="msg"></div>
                  </form>
                </div>

                <!-- Đăng nhập -->
                <div id="tabSignin" class="flex-auto p-6 hidden">
                  <form id="formSignin">
                    <div class="mb-3">
                      <input
                        id="loginEmail"
                        type="email"
                        class="input"
                        placeholder="Email"
                      />
                    </div>
                    <div class="mb-3">
                      <input
                        id="loginPassword"
                        type="password"
                        class="input"
                        placeholder="Mật khẩu"
                      />
                    </div>
                    <button type="submit" class="btn-primary mt-2">
                      Đăng nhập
                    </button>
                    <div id="signinMsg" class="msg"></div>
                  </form>

                  <div class="mt-4 text-center">
                    <a
                      href="UI_SignUp_TD-UV.html"
                      class="text-sm text-blue-600 hover:underline"
                    >
                  </div>
                </div>
              </div>

              <p class="text-xs text-center text-slate-400 mt-3">
                ©
                <script>
                  document.write(new Date().getFullYear());
                </script>
                Duantuyendung
              </p>
            </div>
          </div>
        </div>
      </section>

      <!-- Backdrop & Modal chọn ngành -->
      <div id="catsBackdrop" class="modal-backdrop" aria-hidden="true"></div>
      <div
        id="catsModal"
        class="modal"
        role="dialog"
        aria-modal="true"
        aria-labelledby="catsTitle"
      >
        <div class="modal-card" tabindex="-1">
          <div class="modal-header">
            <div id="catsTitle" class="modal-title">Chọn ngành nghề</div>
            <div class="flex-1"></div>
            <button type="button" id="btnCloseCats" class="btn btn-outline">
              Đóng
            </button>
          </div>
          <div class="modal-body">
            <input
              id="catSearch"
              type="text"
              class="search-input"
              placeholder="Tìm kiếm ngành... (gõ để lọc)"
            />
            <div class="toolbar">
              <button type="button" id="btnSelectAll" class="btn btn-outline">
                Chọn tất cả (đang lọc)
              </button>
              <button type="button" id="btnClearAll" class="btn btn-outline">
                Bỏ chọn tất cả
              </button>
              <span id="catCount" class="muted"></span>
            </div>
            <div id="catList" class="cat-list"></div>
          </div>
          <div class="modal-footer">
            <button type="button" id="btnSaveCats" class="btn btn-primary-sm">
              Lưu lựa chọn
            </button>
          </div>
        </div>
      </div>
    </main>

    <!-- plugin for scrollbar  -->
    <script src="../assets/js/plugins/perfect-scrollbar.min.js" async></script>
    <!-- main script file  -->
    <script
      src="../assets/js/argon-dashboard-tailwind.js?v=1.0.1"
      async
    ></script>

    <!-- ỨNG DỤNG -->
    <script type="module">
      import { BASE_URL, API_BASE } from "../assets/js/config.js";

      // ====== SETUP BASE PATHS ======
      window.BASE_INTERFACE = BASE_URL + "interface";
      window.API_BASE = API_BASE;
      window.URL_UV_HOME =
        BASE_URL + "interface/build/pages/UI_UV/uv-home.html";
      window.URL_TD_HOME =
        BASE_URL + "interface/build/pages/UI_TD/UI_Nhatuyendung_Trangchu.html";

      // ====== TAB ======
      const btnTabSignup = document.getElementById("btnTabSignup");
      const btnTabSignin = document.getElementById("btnTabSignin");
      const tabSignup = document.getElementById("tabSignup");
      const tabSignin = document.getElementById("tabSignin");
      btnTabSignup.addEventListener("click", () => {
        btnTabSignup.classList.add("active");
        btnTabSignin.classList.remove("active");
        tabSignup.classList.remove("hidden");
        tabSignin.classList.add("hidden");
      });
      btnTabSignin.addEventListener("click", () => {
        btnTabSignin.classList.add("active");
        btnTabSignup.classList.remove("active");
        tabSignin.classList.remove("hidden");
        tabSignup.classList.add("hidden");
      });

      // ====== ROLE TOGGLE ======
      const uvFields = document.getElementById("uvFields");
      const ntdFields = document.getElementById("ntdFields");
      document.querySelectorAll('input[name="loaiTaiKhoan"]').forEach((r) => {
        r.addEventListener("change", () => {
          if (r.checked && r.value === "UngVien") {
            uvFields.classList.remove("hidden");
            ntdFields.classList.add("hidden");
          }
          if (r.checked && r.value === "NhaTuyenDung") {
            ntdFields.classList.remove("hidden");
            uvFields.classList.add("hidden");
          }
        });
      });

      // ====== CATEGORIES (Modal + Search + Checkbox) ======
      const btnOpenCats = document.getElementById("btnOpenCats");
      const catsModal = document.getElementById("catsModal");
      const catsBackdrop = document.getElementById("catsBackdrop");
      const btnCloseCats = document.getElementById("btnCloseCats");
      const btnSaveCats = document.getElementById("btnSaveCats");
      const btnSelectAll = document.getElementById("btnSelectAll");
      const btnClearAll = document.getElementById("btnClearAll");
      const catSearch = document.getElementById("catSearch");
      const catList = document.getElementById("catList");
      const catCount = document.getElementById("catCount");
      const selectedChips = document.getElementById("selectedChips");

      let allCats = []; // [{MaDanhMuc, TenDanhMuc}]
      let selectedCats = new Set();
      let tempSelected = new Set();
      let filtered = [];

      async function loadCategories() {
        try {
          const rs = await fetch(API_BASE + "get_categories.php");
          const js = await rs.json();
          if (js.ok) {
            allCats = js.data || [];
            filtered = [...allCats];
            renderCatList();
            updateCount();
            renderSelectedChips();
          } else {
            catList.innerHTML = `<div class="muted">Tải danh mục thất bại</div>`;
          }
        } catch (e) {
          catList.innerHTML = `<div class="muted">Lỗi kết nối danh mục</div>`;
        }
      }
      loadCategories();

      function lockBodyScroll(lock) {
        if (lock) document.body.style.overflow = "hidden";
        else document.body.style.overflow = "";
      }
      function openCatsModal() {
        tempSelected = new Set(selectedCats);
        catSearch.value = "";
        filtered = [...allCats];
        renderCatList();
        updateCount();
        catsModal.classList.add("open");
        catsBackdrop.classList.add("open");
        lockBodyScroll(true);
        setTimeout(() => catSearch.focus(), 50);
      }
      function closeCatsModal() {
        catsModal.classList.remove("open");
        catsBackdrop.classList.remove("open");
        lockBodyScroll(false);
      }
      btnOpenCats.addEventListener("click", openCatsModal);
      btnCloseCats.addEventListener("click", closeCatsModal);
      catsBackdrop.addEventListener("click", closeCatsModal);
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && catsModal.classList.contains("open"))
          closeCatsModal();
      });
      btnSaveCats.addEventListener("click", () => {
        selectedCats = new Set(tempSelected);
        renderSelectedChips();
        closeCatsModal();
      });

      let searchTimer = null;
      catSearch.addEventListener("input", () => {
        if (searchTimer) clearTimeout(searchTimer);
        searchTimer = setTimeout(() => {
          const q = catSearch.value.trim().toLowerCase();
          filtered = q
            ? allCats.filter((c) =>
                (c.TenDanhMuc || "").toLowerCase().includes(q)
              )
            : [...allCats];
          renderCatList();
          updateCount();
        }, 180);
      });

      function renderCatList() {
        if (!filtered.length) {
          catList.innerHTML = `<div class="muted p-3">Không có ngành phù hợp.</div>`;
          return;
        }
        const frag = document.createDocumentFragment();
        filtered.forEach((c) => {
          const idNum = Number(c.MaDanhMuc);
          const row = document.createElement("div");
          row.className = "cat-item";
          const cb = document.createElement("input");
          cb.type = "checkbox";
          cb.id = "cat_" + idNum;
          cb.checked = tempSelected.has(idNum);
          cb.addEventListener("change", () => {
            if (cb.checked) tempSelected.add(idNum);
            else tempSelected.delete(idNum);
            updateCount();
          });
          const label = document.createElement("label");
          label.setAttribute("for", "cat_" + idNum);
          label.textContent = c.TenDanhMuc;
          row.appendChild(cb);
          row.appendChild(label);
          frag.appendChild(row);
        });
        catList.innerHTML = "";
        catList.appendChild(frag);
      }
      function updateCount() {
        const total = allCats.length,
          filt = filtered.length,
          sel = tempSelected.size;
        catCount.textContent = `Đang hiển thị ${filt}/${total} ngành · Đã chọn ${sel}`;
      }
      btnSelectAll.addEventListener("click", () => {
        filtered.forEach((c) => tempSelected.add(Number(c.MaDanhMuc)));
        renderCatList();
        updateCount();
      });
      btnClearAll.addEventListener("click", () => {
        tempSelected.clear();
        renderCatList();
        updateCount();
      });

      function renderSelectedChips() {
        selectedChips.innerHTML = "";
        if (!selectedCats.size) {
          selectedChips.innerHTML = `<span class="muted">Chưa chọn ngành nào</span>`;
          return;
        }
        const byId = new Map(
          allCats.map((c) => [Number(c.MaDanhMuc), c.TenDanhMuc])
        );
        Array.from(selectedCats)
          .sort((a, b) => a - b)
          .forEach((id) => {
            const name = byId.get(Number(id)) || "#" + id;
            const chip = document.createElement("span");
            chip.className = "chip-small";
            chip.innerHTML = `${name} <span class="chip-x" title="Bỏ chọn">&times;</span>`;
            chip.querySelector(".chip-x").addEventListener("click", () => {
              selectedCats.delete(Number(id));
              renderSelectedChips();
            });
            selectedChips.appendChild(chip);
          });
      }

      // ====== UPLOAD ẢNH CV (ứng viên) ======
      const uvAnhCV = document.getElementById("uvAnhCV");
      const cvPreviewWrap = document.getElementById("cvPreviewWrap");
      const cvPreview = document.getElementById("cvPreview");
      const cvMsg = document.getElementById("cvMsg");
      let uploadedCvRelPath = null;

      uvAnhCV.addEventListener("change", async (e) => {
        const file = e.target.files && e.target.files[0];
        uploadedCvRelPath = null;
        cvMsg.className = "msg text-slate-600";
        cvMsg.textContent = "";
        if (!file) {
          cvPreviewWrap.classList.add("hidden");
          return;
        }
        const fd = new FormData();
        fd.append("cv", file);
        cvMsg.textContent = "Đang tải ảnh CV...";
        try {
          const rs = await fetch(API_BASE + "upload_cv.php", {
            method: "POST",
            body: fd,
          });
          const js = await rs.json();
          if (js.ok) {
            uploadedCvRelPath = js.data.relPath;
            cvPreview.src =
              (window.BASE_INTERFACE || "") + "/" + uploadedCvRelPath;
            cvPreviewWrap.classList.remove("hidden");
            cvMsg.className = "msg text-green-600";
            cvMsg.textContent = "Tải ảnh thành công";
          } else {
            cvPreviewWrap.classList.add("hidden");
            cvMsg.className = "msg text-red-600";
            cvMsg.textContent = js.error || "Tải ảnh thất bại";
          }
        } catch {
          cvPreviewWrap.classList.add("hidden");
          cvMsg.className = "msg text-red-600";
          cvMsg.textContent = "Lỗi kết nối khi tải ảnh";
        }
      });

      // ====== SIGNUP ======
      const formSignup = document.getElementById("formSignup");
      const signupMsg = document.getElementById("signupMsg");
      formSignup.addEventListener("submit", async (e) => {
        e.preventDefault();
        signupMsg.className = "msg text-slate-600";
        signupMsg.textContent = "Đang xử lý...";

        const role = document.querySelector(
          'input[name="loaiTaiKhoan"]:checked'
        ).value;
        const payload = {
          email: document.getElementById("email").value.trim(),
          password: document.getElementById("password").value,
          loaiTaiKhoan: role,
          danhMucIds: Array.from(selectedCats),
        };
        if (role === "UngVien") {
          payload.hoTen = document.getElementById("uvHoTen").value.trim();
          payload.soDienThoai = document
            .getElementById("uvSoDienThoai")
            .value.trim();
          if (uploadedCvRelPath) payload.anhCV = uploadedCvRelPath;
        } else {
          payload.tenCongTy = document
            .getElementById("ntdTenCongTy")
            .value.trim();
          payload.soDienThoai = document
            .getElementById("ntdSoDienThoai")
            .value.trim();
          payload.diaChi = document.getElementById("ntdDiaChi").value.trim();
        }

        try {
          const rs = await fetch(API_BASE + "auth_register.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const js = await rs.json();
          if (js.ok) {
            signupMsg.className = "msg text-green-600";
            signupMsg.textContent =
              "Đăng ký thành công! Chuyển qua đăng nhập...";
            setTimeout(() => btnTabSignin.click(), 800);
          } else {
            signupMsg.className = "msg text-red-600";
            signupMsg.textContent = js.error || "Đăng ký thất bại";
          }
        } catch {
          signupMsg.className = "msg text-red-600";
          signupMsg.textContent = "Lỗi kết nối máy chủ";
        }
      });

      // ====== SIGNIN ======
      const formSignin = document.getElementById("formSignin");
      const signinMsg = document.getElementById("signinMsg");
      formSignin.addEventListener("submit", async (e) => {
        e.preventDefault();
        signinMsg.className = "msg text-slate-600";
        signinMsg.textContent = "Đang xử lý...";
        const payload = {
          email: document.getElementById("loginEmail").value.trim(),
          password: document.getElementById("loginPassword").value,
        };
        try {
          const rs = await fetch(API_BASE + "auth_login.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const js = await rs.json();
          if (js.ok) {
            signinMsg.className = "msg text-green-600";
            signinMsg.textContent =
              "Đăng nhập thành công! Đang chuyển trang...";

            // Lưu thông tin auth vào localStorage
            const role = js.data.LoaiTaiKhoan;
            localStorage.setItem(
              "auth",
              JSON.stringify({
                ok: true,
                role: role,
                email:
                  js.data.Email ||
                  document.getElementById("loginEmail").value.trim(),
                MaTK: js.data.MaTK || null,
                MaTaiKhoan: js.data.MaTK || null,
                MaUngVien: js.data.MaUngVien || js.data.MaUngvien || null,
                MaNTD: js.data.MaNTD || js.data.MaNhatuyendung || null,
                HoTen: js.data.HoTen || null,
                TenCongTy: js.data.TenCongTy || null,
                LoaiTaiKhoan: js.data.LoaiTaiKhoan || null,
                userId: js.data.MaTK || null,
                token: js.token || null,
              })
            );

            // ⭐ Đánh dấu điều hướng trong app (tránh auto-logout do pagehide)
            sessionStorage.setItem("navInApp", "1");

            // Điều hướng
            window.location.href =
              role === "UngVien" ? window.URL_UV_HOME : window.URL_TD_HOME;
          } else {
            signinMsg.className = "msg text-red-600";
            signinMsg.textContent = js.error || "Đăng nhập thất bại";
          }
        } catch {
          signinMsg.className = "msg text-red-600";
          signinMsg.textContent = "Lỗi kết nối máy chủ";
        }
      });
    </script>

    <!-- ⭐ NHÚNG AUTO-LOGOUT: đường dẫn từ trang login -->
    <script src="../assets/js/auto-logout.js"></script>

    <!-- XỬ LÝ ?logged_out=1 NGAY TẠI TRANG LOGIN + nhận tín hiệu forceLogout -->
    <script>
      (function () {
        const p = new URLSearchParams(location.search);
        if (p.get("logged_out") === "1") {
          try {
            localStorage.removeItem("auth");
            sessionStorage.removeItem("navInApp");
            sessionStorage.removeItem("skipCloseLogoutOnce");
          } catch {}
          if (history.replaceState)
            history.replaceState({}, "", location.pathname);
        }
        window.addEventListener("storage", (e) => {
          if (e.key === "forceLogout" && e.newValue) {
            try {
              localStorage.removeItem("auth");
            } catch {}
          }
        });
      })();
    </script>
  </body>
</html>
