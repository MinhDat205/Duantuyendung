<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <title>NTD • Quản lý ứng viên</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <!-- Fonts & Icons -->
    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700"
      rel="stylesheet"
    />
    <script
      src="https://kit.fontawesome.com/42d5adcbca.js"
      crossorigin="anonymous"
    ></script>

    <!-- Argon -->
    <link href="../../assets/css/nucleo-icons.css" rel="stylesheet" />
    <link href="../../assets/css/nucleo-svg.css" rel="stylesheet" />
    <link
      href="../../assets/css/argon-dashboard-tailwind.css?v=1.0.1"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: "Open Sans", sans-serif;
      }
      /* Ảnh nền cho toàn bộ main */
      main {
        background: url("../../assets/img/Trangchu.jpg") no-repeat center center;
        background-size: cover;
        position: relative;
        min-height: 100vh;
      }
      main::before {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
          to bottom,
          rgba(255, 255, 255, 0.85),
          rgba(255, 255, 255, 0.95)
        );
        z-index: 0;
        border-radius: 1rem;
      }
      main > * {
        position: relative;
        z-index: 1;
      }

      /* Navbar styles */
      nav {
        background: linear-gradient(to right, #ffffff, #f8fafc);
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      /* Card styles */
      .candidate-card {
        background: #ffffff;
        border: 1px solid rgba(229, 231, 235, 0.3);
        border-radius: 1.25rem;
        padding: 1.75rem;
        transition: all 0.3s ease-in-out;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      }
      .candidate-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
        border-color: #3b82f6;
      }

      /* Search panel styles */
      .search-panel {
        background: #ffffff;
        border: 1px solid rgba(229, 231, 235, 0.3);
        border-radius: 1.25rem;
        padding: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
      }
      .search-panel:hover {
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
      }

      /* Input styles */
      input,
      select {
        transition: all 0.3s ease;
      }
      input:focus,
      select:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      /* Badge styles */
      .badge {
        border-radius: 0.75rem;
        padding: 0.375rem 0.875rem;
        font-size: 0.825rem;
        font-weight: 500;
      }
      .badge.dangxet {
        background: #cffafe;
        color: #0e7490;
      }
      .badge.moiphongvan {
        background: #dcfce7;
        color: #15803d;
      }
      .badge.tuchoi {
        background: #fee2e2;
        color: #b91c1c;
      }

      /* Button styles */
      button {
        transition: all 0.3s ease;
      }
      button:hover {
        transform: scale(1.05);
      }
      [data-action] {
        background: #2563eb;
        color: #ffffff;
        font-weight: 600;
        font-size: 0.9rem;
        padding: 0.75rem 1.5rem;
        border-radius: 0.75rem;
        border: none;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      [data-action]:hover {
        background: #1e40af;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }
      [data-action="tuchoi"] {
        background: #dc2626;
      }
      [data-action="tuchoi"]:hover {
        background: #b91c1c;
      }
      [data-action="close"] {
        background: #6b7280;
      }
      [data-action="close"]:hover {
        background: #4b5563;
      }

      /* Modal styles */
      .modal {
        background: rgba(0, 0, 0, 0.5);
        display: none;
        position: fixed;
        inset: 0;
        z-index: 50;
        align-items: center;
        justify-content: center;
      }
      .modal.open {
        display: flex;
      }
      .modal-content {
        background: #ffffff;
        border-radius: 1.25rem;
        padding: 2rem;
        max-width: 600px;
        width: 90%;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
      }

      /* Responsive adjustments */
      @media (max-width: 640px) {
        .search-panel {
          padding: 1.25rem;
        }
        .candidate-card {
          padding: 1.25rem;
        }
        .grid {
          grid-template-columns: 1fr;
        }
        [data-action] {
          padding: 0.5rem 1rem;
          font-size: 0.85rem;
        }
      }
    </style>
  </head>
  <body class="m-0 font-sans text-base antialiased bg-gray-50 text-slate-600">
    <!-- Placeholder Sidenav -->
    <div
      id="sidenav-container"
      role="complementary"
      aria-label="Thanh điều hướng nhà tuyển dụng"
    ></div>

    <script>
      (async function loadSidenav() {
        try {
          const res = await fetch("Sidenav_nhatuyendung.html", {
            cache: "no-store",
          });
          if (!res.ok) throw new Error("HTTP " + res.status);
          const html = await res.text();
          const host = document.getElementById("sidenav-container");
          host.innerHTML = html;

          const logoutBtn = host.querySelector("#btnLogout");
          if (logoutBtn) {
            logoutBtn.addEventListener("click", function (e) {
              e.preventDefault();
              try {
                localStorage.removeItem("auth");
              } catch {}
              window.location.href = "../UI_SignUp_TD-UV.html";
            });
          }
        } catch (e) {
          console.error("Không thể tải Sidenav_nhatuyendung.html", e);
        }
      })();
    </script>

    <main
      class="relative h-full min-h-screen transition-all duration-200 ease-in-out xl:ml-68 rounded-xl overflow-hidden"
    >
      <!-- Navbar -->
      <nav
        class="mx-6 mt-4 px-6 py-4 bg-white/95 backdrop-blur-md rounded-2xl shadow-md"
      >
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <img src="../../assets/img/logo.png" alt="Logo" class="h-8" />
            <h6 class="font-bold text-lg text-gray-900">Quản lý ứng viên</h6>
          </div>
          <div class="text-sm text-slate-700">
            Xin chào, <span id="ntdEmail">nhà tuyển dụng</span>
          </div>
        </div>
      </nav>

      <!-- Nội dung -->
      <div class="w-full px-6 py-8 mx-auto max-w-7xl">
        <!-- Search Panel -->
        <div class="search-panel">
          <div class="flex items-center gap-4 flex-wrap">
            <input
              id="kw"
              placeholder="Tìm theo tên ứng viên hoặc chức danh..."
              class="flex-1 min-w-64 px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
            <select
              id="statusFilter"
              class="min-w-48 px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="">Tất cả trạng thái</option>
              <option value="DangXet">Đang xét</option>
              <option value="MoiPhongVan">Mời phỏng vấn</option>
              <option value="TuChoi">Từ chối</option>
            </select>
            <button
              id="btnSearch"
              class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
            >
              Tìm kiếm
            </button>
            <span class="text-sm text-gray-600">
              <span id="result-count">Đang tải...</span>
            </span>
          </div>
        </div>

        <!-- Candidate List -->
        <div
          id="list"
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-6"
        ></div>

        <!-- Modal for Candidate Details -->
        <div id="candidateModal" class="modal">
          <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-semibold text-gray-900">
                Thông tin ứng viên
              </h3>
              <button id="closeModal" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div id="candidateDetails"></div>
            <div class="flex gap-3 mt-4">
              <button data-action="close" class="bg-gray-500 text-white">
                Tắt
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script type="module">
      import { BASE_URL, API_BASE } from "../../assets/js/config.js";

      // Guard + common helpers
      const authRaw = localStorage.getItem("auth");
      const auth = authRaw ? JSON.parse(authRaw) : null;
      const LOGIN_PAGE =
        BASE_URL + "interface/build/pages/UI_SignUp_TD-UV.html";
      if (
        !auth ||
        !auth.ok ||
        (auth.LoaiTaiKhoan && auth.LoaiTaiKhoan !== "NhaTuyenDung")
      ) {
        window.location.href = LOGIN_PAGE;
      }
      function getNTDId() {
        return Number(
          auth?.MaNTD ?? auth?.MaTK ?? auth?.userId ?? auth?.id ?? 0
        );
      }
      const NTD_EMAIL = auth?.email || auth?.Email || "";
      document.getElementById("ntdEmail").textContent =
        NTD_EMAIL || "nhà tuyển dụng";

      async function post(path, body = {}) {
        try {
          const res = await fetch(API_BASE + path, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });
          const data = await res
            .json()
            .catch(() => ({ status: "error", message: "Invalid JSON" }));
          if (!data.ok && data.status !== "success") {
            throw new Error(data.message || "API error");
          }
          return data;
        } catch (err) {
          throw new Error(err.message || "Lỗi kết nối server");
        }
      }

      // Search + render
      async function search() {
        document.getElementById("result-count").textContent = "Đang tải...";
        try {
          const body = {
            MaNTD: getNTDId(),
            keyword: document.getElementById("kw").value.trim(),
            TrangThai: document.getElementById("statusFilter").value,
          };
          const r = await post("API_show_Ungtuyen.php", body);
          render(r.data || []);
        } catch (err) {
          console.error("Search error:", err);
          document.getElementById("result-count").textContent =
            "Lỗi khi tải dữ liệu";
          render([]);
        }
      }

      const listEl = document.getElementById("list");
      function render(items) {
        document.getElementById(
          "result-count"
        ).textContent = `${items.length} ứng viên`;
        listEl.innerHTML = "";
        items.forEach((item) => {
          const card = document.createElement("div");
          card.className = "candidate-card";
          card.innerHTML = `
            <div class="flex flex-col h-full">
              <div class="flex-1">
                <h3 class="text-lg font-semibold text-gray-900 mb-2">${
                  item.HoTen || "Ứng viên"
                }</h3>
                <p class="text-gray-600 font-medium mb-2">${
                  item.ChucDanh || "N/A"
                }</p>
                <p class="text-sm text-gray-500 mb-3">${
                  item.DiaDiemLamViec || "N/A"
                } • ${item.MucLuong || "Thoả thuận"}</p>
                <p class="text-sm text-gray-600 mb-4">Ngày ứng tuyển: ${
                  item.NgayUngTuyen
                    ? new Date(item.NgayUngTuyen).toLocaleDateString("vi-VN")
                    : "N/A"
                }</p>
              </div>
              <div class="flex items-center justify-between">
                <span class="badge ${item.TrangThai.toLowerCase()}" id="st-${
            item.MaUngTuyen
          }">
                  ${
                    item.TrangThai === "DangXet"
                      ? "Đang xét"
                      : item.TrangThai === "MoiPhongVan"
                      ? "Mời phỏng vấn"
                      : "Từ chối"
                  }
                </span>
                <div class="flex gap-3">
                  <button data-action="view" data-id="${
                    item.MaUngVien
                  }" data-apply-id="${item.MaUngTuyen}">
                    Xem chi tiết
                  </button>
                  <button data-action="moiphongvan" data-apply-id="${
                    item.MaUngTuyen
                  }" data-tin-id="${item.MaTin}" class="${
            item.TrangThai === "MoiPhongVan" || item.TrangThai === "TuChoi"
              ? "hidden"
              : ""
          }">
                    Mời phỏng vấn
                  </button>
                  <button data-action="tuchoi" data-apply-id="${
                    item.MaUngTuyen
                  }" class="${item.TrangThai === "TuChoi" ? "hidden" : ""}">
                    Từ chối
                  </button>
                </div>
              </div>
            </div>
          `;
          listEl.appendChild(card);
        });
      }

      // Load candidate details
      async function loadCandidateDetails(MaUngVien, MaUngTuyen) {
        try {
          const r = await post("API_show_Ungvien.php", { MaUngVien });
          const data = r.data;
          const modalContent = document.getElementById("candidateDetails");
          modalContent.innerHTML = `
            <p><strong>Họ tên:</strong> ${data.HoTen || "N/A"}</p>
            <p><strong>Email:</strong> ${data.Email || "N/A"}</p>
            <p><strong>Số điện thoại:</strong> ${data.SoDienThoai || "N/A"}</p>
            <p><strong>Kỹ năng:</strong> ${data.KyNang || "N/A"}</p>
            <p><strong>Kinh nghiệm:</strong> ${data.KinhNghiem || "N/A"}</p>
            ${
              data.AnhCV
                ? `<p><strong>CV:</strong> <a href="/Duantuyendung/interface/${data.AnhCV}" target="_blank" class="text-blue-600 hover:underline">Xem CV</a></p>`
                : ""
            }
          `;
          document.getElementById("candidateModal").classList.add("open");
        } catch (err) {
          console.error("Load candidate details error:", err);
          alert("Lỗi khi tải thông tin ứng viên: " + err.message);
        }
      }

      // Update application status
      async function updateStatus(MaUngTuyen, TrangThai, MaTin) {
        try {
          const r = await post("API_update_Ungtuyen.php", {
            MaUngTuyen,
            TrangThai,
            MaNTD: getNTDId(),
          });
          if (r.status === "success") {
            await search();
            alert(
              `Đã cập nhật trạng thái thành ${
                TrangThai === "MoiPhongVan" ? "Mời phỏng vấn" : "Từ chối"
              }`
            );
            if (TrangThai === "MoiPhongVan") {
              window.location.href = `UI_TD_Chat.html?MaTin=${MaTin}&MaUngTuyen=${MaUngTuyen}`;
            }
          } else {
            alert(
              "Lỗi khi cập nhật trạng thái: " + (r.message || "Unknown error")
            );
          }
        } catch (err) {
          console.error("Update status error:", err);
          alert("Lỗi khi cập nhật trạng thái: " + err.message);
        }
      }

      // Event listeners
      listEl.addEventListener("click", async (e) => {
        const actionBtn = e.target.closest("[data-action]");
        if (actionBtn) {
          const action = actionBtn.dataset.action;
          const MaUngTuyen = Number(actionBtn.dataset.applyId);
          const MaUngVien = Number(actionBtn.dataset.id);
          const MaTin = Number(actionBtn.dataset.tinId);

          if (action === "view") {
            await loadCandidateDetails(MaUngVien, MaUngTuyen);
          } else if (action === "moiphongvan" || action === "tuchoi") {
            await updateStatus(
              MaUngTuyen,
              action === "moiphongvan" ? "MoiPhongVan" : "TuChoi",
              MaTin
            );
          }
        }
      });

      document.getElementById("closeModal").addEventListener("click", () => {
        document.getElementById("candidateModal").classList.remove("open");
      });

      document
        .getElementById("candidateModal")
        .addEventListener("click", (e) => {
          const actionBtn = e.target.closest("[data-action]");
          if (actionBtn && actionBtn.dataset.action === "close") {
            document.getElementById("candidateModal").classList.remove("open");
          }
        });

      // Init
      (async () => {
        await search();
        document.getElementById("btnSearch").onclick = search;
        document.getElementById("statusFilter").onchange = search;
        document.getElementById("kw").oninput = () => {
          if (
            document.getElementById("kw").value.length >= 2 ||
            document.getElementById("kw").value.length === 0
          ) {
            search();
          }
        };
      })();
    </script>
  </body>
</html>
