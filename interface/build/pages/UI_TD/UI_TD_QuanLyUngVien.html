<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quản lý ứng viên</title>

  <!-- Argon / Tailwind assets -->
  <link href="../../assets/css/nucleo-icons.css" rel="stylesheet" />
  <link href="../../assets/css/nucleo-svg.css" rel="stylesheet" />
  <link href="../../assets/css/argon-dashboard-tailwind.css?v=1.0.1" rel="stylesheet" />
  <!-- FA qua CSS để tránh 403 từ kit -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        referrerpolicy="no-referrer">

  <style>
    .badge { padding: .35rem .65rem; border-radius: .5rem; font-size: .75rem; font-weight: 700; color:#fff }
    .badge-gray { background: linear-gradient(to top left,#475569,#94a3b8);}
    .badge-blue { background: linear-gradient(to top left,#1e3a8a,#06b6d4);}
    .badge-red  { background: linear-gradient(to top left,#dc2626,#f97316);}

    .btn-pill { padding:.45rem .7rem; border-radius:.6rem; font-size:.8rem; font-weight:700; color:#fff; border:none }
    .btn-gray { background: linear-gradient(to top left,#475569,#94a3b8);}
    .btn-blue { background: linear-gradient(to top left,#1e3a8a,#06b6d4);}
    .btn-red  { background: linear-gradient(to top left,#dc2626,#f97316);}
  </style>
</head>
<body class="bg-gray-50 text-slate-600">
  <div class="absolute w-full bg-blue-500 min-h-75"></div>

  <!-- Sidebar -->
  <aside class="fixed inset-y-0 my-4 w-full max-w-64 bg-white shadow-xl rounded-2xl xl:left-0 xl:translate-x-0 overflow-y-auto">
    <div class="h-19"><a class="block px-8 py-6 font-semibold" href="../dashboard.html">Argon Dashboard</a></div>
    <hr class="h-px bg-gradient-to-r from-transparent via-black/40 to-transparent" />
    <ul class="flex flex-col">
      <li><a class="px-4 py-2 flex items-center m-2" href="./td-ho-so.html">Hồ sơ Tuyển Dụng</a></li>
      <li><a class="px-4 py-2 flex items-center bg-blue-100 rounded-lg m-2" href="./td-quan-ly-ung-vien.html">Quản lý ứng viên</a></li>
      <li><a class="px-4 py-2 flex items-center m-2" href="./td-quan-ly-tin.html">Quản Lý Tin Tuyển Dụng</a></li>
    </ul>
  </aside>

  <main class="relative h-full max-h-screen xl:ml-68 rounded-xl">
    <nav class="relative flex items-center px-6 py-2 mx-6 rounded-2xl">
      <h6 class="mb-0 font-bold text-white">Quản lý ứng viên</h6>
    </nav>

    <div class="w-full px-6 py-6 mx-auto">
      <div class="bg-white rounded-2xl shadow-xl">
        <!-- Bộ lọc theo Mã Ứng Viên -->
        <div class="p-6 border-b flex flex-wrap gap-3 items-center">
          <div class="text-xs font-bold">Mã ứng viên:</div>
          <input id="inp-ma-uv" type="number" class="rounded-lg border px-3 py-2 min-w-[180px]" placeholder="Nhập mã ứng viên...">
          <button id="btn-load" class="px-3 py-2 bg-blue-500 text-white rounded-lg text-sm">
            <i class="fa-solid fa-magnifying-glass mr-1"></i> Xem
          </button>
          <div id="uv-info" class="ml-auto text-sm text-slate-400"></div>
        </div>

        <!-- Bảng ứng viên -->
        <div class="p-6">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr class="text-xxs uppercase text-slate-400">
                  <th class="px-6 py-3 text-left">Tên</th>
                  <th class="px-6 py-3 text-left">Ngày ứng tuyển</th>
                  <th class="px-6 py-3 text-center">Trạng thái</th>
                  <th class="px-6 py-3 text-right">Hành động</th>
                </tr>
              </thead>
              <tbody id="tb-apps" class="border-t">
                <tr><td colspan="4" class="px-6 py-6 text-slate-400">Nhập mã ứng viên rồi bấm “Xem”.</td></tr>
              </tbody>
            </table>
          </div>
          <div class="mt-4 text-xs text-slate-400 flex items-center gap-3">
            <span class="badge badge-gray">Đang xét</span>
            <span class="badge badge-blue">Mời phỏng vấn</span>
            <span class="badge badge-red">Từ chối</span>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- ===== JS ===== -->
  <script>
    // Host cố định, dùng API thư mục bạn đã cấu hình
    const API_HOST = 'http://localhost:8080';
    const API_BASE = `${API_HOST}/Duantuyendung/API/`;
    const API_SHOW_UT   = `${API_BASE}API_show_Ungtuyen.php`;   // ?MaUngVien=...
    const API_UPDATE_UT = `${API_BASE}API_update_Ungtuyen.php`; // POST MaUngTuyen, TrangThai

    const STATUS_MAP = {
      'DangXet':     { label: 'Đang xét',      badge: 'badge-gray', btn: 'btn-gray' },
      'MoiPhongVan': { label: 'Mời phỏng vấn', badge: 'badge-blue', btn: 'btn-blue' },
      'TuChoi':      { label: 'Từ chối',       badge: 'badge-red',  btn: 'btn-red'  },
    };

    let CURRENT_UV = { id: null, name: null };
    let CURRENT_ROWS = [];

    async function fetchJSON(url, opt={}) {
      const res  = await fetch(url, opt);
      const text = await res.text();
      if (!res.ok) { alert(`HTTP ${res.status} @ ${url}\n\n${text.slice(0,300)}`); throw new Error(res.status); }
      const ct = res.headers.get('content-type') || '';
      if (!ct.includes('application/json')) { alert(`API không trả JSON @ ${url}\n\n${text.slice(0,300)}`); throw new Error('Not JSON'); }
      return JSON.parse(text);
    }

    async function loadByUngVien() {
      const id = document.getElementById('inp-ma-uv').value.trim();
      if (!id) { alert('Nhập Mã Ứng Viên'); return; }

      const url = `${API_SHOW_UT}?MaUngVien=${encodeURIComponent(id)}`;
      document.getElementById('tb-apps').innerHTML =
        `<tr><td colspan="4" class="px-6 py-6 text-slate-400">Đang tải…</td></tr>`;

      try {
        const js = await fetchJSON(url);
        if (js.status !== 'success') throw new Error(js.message || 'Lỗi tải dữ liệu');
        const data = js.data || [];
        CURRENT_ROWS = data;

        // Suy tên ứng viên nếu API có HoTen; nếu không hiển thị "Ứng viên #ID"
        const name = data.length && data[0].HoTen ? data[0].HoTen : `Ứng viên #${id}`;
        CURRENT_UV = { id, name };
        document.getElementById('uv-info').textContent = name;

        renderTable();
      } catch (e) {
        console.error(e);
        document.getElementById('tb-apps').innerHTML =
          `<tr><td colspan="4" class="px-6 py-6 text-red-500">Lỗi tải dữ liệu</td></tr>`;
      }
    }

    function renderTable() {
      const tb = document.getElementById('tb-apps');
      if (!CURRENT_ROWS.length) {
        tb.innerHTML = `<tr><td colspan="4" class="px-6 py-6 text-slate-400">Chưa có bản ghi ứng tuyển.</td></tr>`;
        return;
      }

      tb.innerHTML = CURRENT_ROWS.map(r => {
        const st = STATUS_MAP[r.TrangThai] || STATUS_MAP.DangXet;
        const ngay = r.NgayUngTuyen ? new Date(r.NgayUngTuyen).toLocaleString() : '-';
        const ten = CURRENT_UV.name || 'Ứng viên';
        return `
          <tr class="border-b">
            <td class="px-6 py-3">${ten}</td>
            <td class="px-6 py-3">${ngay}</td>
            <td class="px-6 py-3 text-center"><span class="badge ${st.badge}">${st.label}</span></td>
            <td class="px-6 py-3 text-right space-x-1">
              <button class="btn-pill btn-gray" onclick="setStatus(${r.MaUngTuyen},'DangXet')">Đang xét</button>
              <button class="btn-pill btn-blue" onclick="setStatus(${r.MaUngTuyen},'MoiPhongVan')">Mời phỏng vấn</button>
              <button class="btn-pill btn-red"  onclick="setStatus(${r.MaUngTuyen},'TuChoi')">Từ chối</button>
            </td>
          </tr>`;
      }).join('');
    }

    async function setStatus(MaUngTuyen, TrangThai) {
      const fd = new FormData();
      fd.append('MaUngTuyen', MaUngTuyen);
      fd.append('TrangThai',  TrangThai);
      try {
        const js = await fetchJSON(API_UPDATE_UT, { method: 'POST', body: fd });
        if (js.status === 'success') {
          await loadByUngVien();
        } else {
          alert(js.message || 'Cập nhật thất bại');
        }
      } catch (e) {
        console.error(e);
        alert('Lỗi API khi cập nhật trạng thái');
      }
    }

    document.getElementById('btn-load').addEventListener('click', loadByUngVien);
  </script>

  <!-- Argon scripts -->
  <script src="../../assets/js/plugins/perfect-scrollbar.min.js" async></script>
  <script src="../../assets/js/argon-dashboard-tailwind.js?v=1.0.1" async></script>
</body>
</html>
