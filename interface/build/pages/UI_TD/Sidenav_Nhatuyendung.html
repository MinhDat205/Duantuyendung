<!-- Sidenav_nhatuyendung.html -->
<aside
  class="fixed inset-y-0 block w-full p-0 my-4 overflow-y-auto bg-white shadow-xl xl:ml-6 max-w-64 rounded-2xl xl:left-0 xl:translate-x-0 z-50"
>
  <!-- Logo / Title -->
  <div class="h-19">
    <a
      class="block px-8 py-6 m-0 text-sm whitespace-nowrap text-slate-700"
      href="UI_Nhatuyendung_Trangchu.html"
      data-nav
    >
      <img
        src="../../assets/img/logo-ct.png"
        class="inline h-full max-w-full max-h-8"
        alt="logo"
      />
      <span class="ml-1 font-semibold">Nhà tuyển dụng</span>
    </a>
  </div>

  <hr
    class="h-px mt-0 bg-transparent bg-gradient-to-r from-transparent via-black/20 to-transparent"
  />

  <!-- Menu items -->
  <div
    class="items-center block w-auto max-h-screen overflow-auto h-sidenav grow basis-full"
  >
    <ul class="flex flex-col pl-0 mb-0">
      <!-- Trang chủ -->
      <li class="mt-0.5 w-full">
        <a
          class="py-2.7 text-sm mx-2 flex items-center whitespace-nowrap px-4 text-slate-700 hover:bg-gray-100 rounded-lg"
          href="UI_Nhatuyendung_Trangchu.html"
          data-nav
        >
          <i class="ni ni-tv-2 mr-2 text-blue-500"></i>
          <span>Trang chủ</span>
        </a>
      </li>

      <!-- Hồ sơ -->
      <li class="mt-0.5 w-full">
        <a
          class="py-2.7 text-sm mx-2 flex items-center whitespace-nowrap px-4 text-slate-700 hover:bg-gray-100 rounded-lg"
          href="UI_TD_HoSo.html"
          data-nav
        >
          <i class="ni ni-single-02 mr-2 text-emerald-500"></i>
          <span>Hồ sơ</span>
        </a>
      </li>

      <!-- Quản lý tin tuyển dụng -->
      <li class="mt-0.5 w-full">
        <a
          class="py-2.7 text-sm mx-2 flex items-center whitespace-nowrap px-4 text-slate-700 hover:bg-gray-100 rounded-lg"
          href="UI_TD_QuanLyTinTuyenDung.html"
          data-nav
        >
          <i class="ni ni-briefcase-24 mr-2 text-orange-500"></i>
          <span>Quản lý tin tuyển dụng</span>
        </a>
      </li>

      <!-- Ứng viên ứng tuyển -->
      <li class="mt-0.5 w-full">
        <a
          class="py-2.7 text-sm mx-2 flex items-center whitespace-nowrap px-4 text-slate-700 hover:bg-gray-100 rounded-lg"
          href="UI_TD_QuanLyUngVienUngTuyen.html"
          data-nav
        >
          <i class="ni ni-circle-08 mr-2 text-purple-500"></i>
          <span>Ứng viên ứng tuyển</span>
        </a>
      </li>

      <!-- Lịch phỏng vấn -->
      <li class="mt-0.5 w-full">
        <a
          id="navLichPhongVan"
          class="py-2.7 text-sm mx-2 flex items-center whitespace-nowrap px-4 text-slate-700 hover:bg-gray-100 rounded-lg"
          href="UI_TD_Lichphongvan.html"
          title="Tạo & quản lý lịch phỏng vấn"
          data-nav
        >
          <i class="ni ni-calendar-grid-58 mr-2 text-indigo-600"></i>
          <span>Lịch phỏng vấn</span>
        </a>
      </li>

      <!-- Chat -->
      <li class="mt-0.5 w-full">
        <a
          id="navChat"
          class="py-2.7 text-sm mx-2 flex items-center whitespace-nowrap px-4 text-slate-700 hover:bg-gray-100 rounded-lg"
          href="UI_TD_Chat.html"
          data-nav
        >
          <i class="ni ni-chat-round mr-2 text-cyan-600"></i>
          <span>Chat</span>
        </a>
      </li>

      <!-- Thông báo -->
      <li class="mt-0.5 w-full">
        <a
          id="tdNotifLink"
          class="py-2.7 text-sm mx-2 flex items-center whitespace-nowrap px-4 text-slate-700 hover:bg-gray-100 rounded-lg"
          href="td-notifications.html"
          data-nav
        >
          <span class="relative mr-2 inline-flex">
            <!-- Bell (SVG, chắc chắn hiển thị) -->
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="1.8"
              class="h-5 w-5 text-blue-500"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M14.857 17.082A4.5 4.5 0 0 1 12 18a4.5 4.5 0 0 1-2.857-.918M5.5 10.5a6.5 6.5 0 1 1 13 0c0 2.863.943 3.806 1.5 4.5H4c.557-.694 1.5-1.637 1.5-4.5Z"
              />
            </svg>
            <span
              id="tdNotificationDot"
              class="absolute -top-1 -right-1 h-2 w-2 bg-red-500 rounded-full hidden"
            ></span>
          </span>
          <span>Thông báo</span>
          <span
            id="tdNotificationBadge"
            class="ml-auto hidden text-xs font-semibold px-2 py-0.5 rounded-full bg-red-500 text-white"
          ></span>
        </a>
      </li>

      <!-- Đăng xuất -->
      <li class="mt-0.5 w-full">
        <button
          id="btnLogout"
          class="w-[calc(100%-1rem)] ml-2 py-2.5 text-left text-sm flex items-center whitespace-nowrap px-4 text-slate-700 hover:bg-gray-100 rounded-lg cursor-pointer"
        >
          <i class="ni ni-button-power mr-2 text-red-600"></i>
          <span>Đăng xuất</span>
        </button>
      </li>
    </ul>
  </div>
</aside>

<script>
  (function () {
    const API_LOGOUT = "/Duantuyendung/interface/API/API_logout_User.php";
    const LOGIN_PAGE =
      "/Duantuyendung/interface/build/pages/UI_SignUp_TD-UV.html?logged_out=1";

    // đánh dấu điều hướng trong app
    document.querySelectorAll("a[data-nav]").forEach((a) => {
      a.addEventListener("click", () => {
        try {
          sessionStorage.setItem("navInApp", "1");
        } catch {}
      });
    });

    function clearClientAuth() {
      try {
        localStorage.removeItem("auth");
        localStorage.removeItem("td_logged_in");
        localStorage.removeItem("uv_logged_in");
        localStorage.removeItem("user_email");
        localStorage.removeItem("auth_token");
        sessionStorage.removeItem("navInApp");
        sessionStorage.removeItem("skipCloseLogoutOnce");
      } catch (_) {}
    }
    function broadcastForceLogout() {
      try {
        localStorage.setItem("forceLogout", String(Date.now()));
      } catch {}
    }
    function serverLogout() {
      try {
        const fd = new FormData();
        fd.append("reason", "manual_click");
        if (navigator.sendBeacon) navigator.sendBeacon(API_LOGOUT, fd);
        else
          fetch(API_LOGOUT, {
            method: "POST",
            body: fd,
            keepalive: true,
          }).catch(() => {});
      } catch (_) {}
    }
    function doLogout() {
      clearClientAuth();
      broadcastForceLogout();
      serverLogout();
      window.location.href = LOGIN_PAGE;
    }

    const btn = document.getElementById("btnLogout");
    if (btn)
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        btn.disabled = true;
        btn.style.opacity = "0.6";
        doLogout();
      });

    // ===== Notifications =====
    async function loadNotificationCount() {
      try {
        const auth = localStorage.getItem("auth");
        if (!auth) return;
        const user = JSON.parse(auth);

        const resp = await fetch(
          "/Duantuyendung/interface/API/API_get_notifications.php",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ MaTK: user.MaTK }),
          }
        );
        const result = await resp.json();

        const count = Number(result?.data?.unread_count || 0);
        const dot = document.getElementById("tdNotificationDot");
        const badge = document.getElementById("tdNotificationBadge");

        if (count > 0) {
          dot && dot.classList.remove("hidden");
          if (badge) {
            badge.textContent = count > 99 ? "99+" : String(count);
            badge.classList.remove("hidden");
            badge.setAttribute("aria-label", `Có ${count} thông báo chưa đọc`);
            badge.setAttribute("title", `${count} thông báo chưa đọc`);
          }
        } else {
          dot && dot.classList.add("hidden");
          if (badge) {
            badge.classList.add("hidden");
            badge.textContent = "";
            badge.removeAttribute("aria-label");
            badge.removeAttribute("title");
          }
        }
      } catch (e) {
        console.error("TD notifications error:", e);
      }
    }

    document.getElementById("tdNotifLink")?.addEventListener("click", () => {
      document.getElementById("tdNotificationDot")?.classList.add("hidden");
      const b = document.getElementById("tdNotificationBadge");
      if (b) {
        b.classList.add("hidden");
        b.textContent = "";
      }
    });

    loadNotificationCount();
  })();
</script>
