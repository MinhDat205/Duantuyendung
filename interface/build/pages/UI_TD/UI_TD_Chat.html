<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Chat với ứng viên | Nhà tuyển dụng</title>

    <!-- Guard: chỉ cho NTD -->
    <script>
      (function () {
        try {
          const auth = JSON.parse(localStorage.getItem("auth") || "null");
          if (!auth || !auth.ok || auth.role !== "NhaTuyenDung") {
            window.location.href = "../UI_SignUp_TD-UV.html";
          }
        } catch {
          window.location.href = "../UI_SignUp_TD-UV.html";
        }
      })();
    </script>

    <!-- Fonts & Icons -->
    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
      referrerpolicy="no-referrer"
    />

    <!-- Argon / Tailwind assets -->
    <link href="../../assets/css/nucleo-icons.css" rel="stylesheet" />
    <link href="../../assets/css/nucleo-svg.css" rel="stylesheet" />
    <link
      href="../../assets/css/argon-dashboard-tailwind.css?v=1.0.1"
      rel="stylesheet"
    />

    <style>
      html,
      body,
      button,
      input,
      textarea,
      select {
        font-family: "Open Sans", ui-sans-serif, system-ui, -apple-system,
          "Segoe UI", Roboto, "Helvetica Neue", Arial, "Apple Color Emoji",
          "Segoe UI Emoji", "Segoe UI Symbol", sans-serif !important;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      .form-input {
        width: 100%;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 0.6rem 0.75rem;
        font-size: 0.95rem;
      }
      .btn-primary {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: linear-gradient(45deg, #111827, #334155);
        color: #fff;
        padding: 0.6rem 1rem;
        border-radius: 0.75rem;
        font-weight: 700;
      }
      .btn-ghost {
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 0.5rem 0.85rem;
      }
      .btn-light {
        border: 1px solid #e5e7eb;
        background: #fff;
        padding: 0.45rem 0.8rem;
        border-radius: 0.6rem;
        font-weight: 700;
        font-size: 0.875rem;
      }
      .btn-light[disabled] {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .toast {
        position: fixed;
        right: 24px;
        bottom: 24px;
        z-index: 100000;
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 16px;
        border-radius: 10px;
        color: #fff;
        font-size: 14px;
        font-weight: 700;
        border: 2px solid rgba(255, 255, 255, 0.95);
        box-shadow: 0 16px 36px rgba(0, 0, 0, 0.38),
          0 10px 18px rgba(0, 0, 0, 0.25);
        opacity: 0;
        transition: opacity 0.25s ease;
      }
      .toast.show {
        opacity: 1;
      }
      .chat-list-item {
        cursor: pointer;
      }
      .chat-list-item.active {
        background: #f1f5f9;
      }
      .bubble {
        max-width: 75%;
        border-radius: 16px;
        padding: 8px 12px;
        font-weight: 500;
        margin-bottom: 8px;
      }
      .bubble.mine {
        background: #2563eb;
        color: #fff;
      }
      .bubble.other {
        background: #f1f5f9;
        color: #000;
        border: 1px solid #d1d5db;
      }
      .badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 800;
      }

      /* Modal tạo lịch */
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(2, 6, 23, 0.5);
        backdrop-filter: blur(2px);
        display: none;
        z-index: 1000;
      }
      .modal {
        position: fixed;
        inset: 0;
        display: none;
        place-items: center;
        z-index: 1001;
      }
      .modal.show,
      .modal-backdrop.show {
        display: grid;
      }
      .modal-card {
        width: 100%;
        max-width: 520px;
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 25px 60px rgba(0, 0, 0, 0.25);
      }
      .modal-head {
        padding: 14px 16px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .modal-body {
        padding: 16px;
      }
      .modal-foot {
        padding: 14px 16px;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: flex-end;
        gap: 8px;
      }
      .text-danger {
        color: #dc2626;
        font-size: 12px;
        margin-top: 6px;
        display: none;
      }
    </style>
  </head>

  <body class="m-0 font-sans text-base antialiased bg-gray-50 text-slate-600">
    <!-- Header bg -->
    <div
      class="absolute w-full top-0 min-h-75 bg-[url('https://raw.githubusercontent.com/creativetimofficial/public-assets/master/argon-dashboard-pro/assets/img/profile-layout-header.jpg')] bg-cover bg-center"
    >
      <span
        class="absolute top-0 left-0 w-full h-full bg-blue-500 opacity-60"
      ></span>
    </div>

    <!-- Sidenav -->
    <div id="sidenav-container" aria-label="Thanh điều hướng NTD"></div>
    <script>
      (async function loadSidenav() {
        try {
          const res = await fetch("Sidenav_Nhatuyendung.html", {
            cache: "no-store",
          });
          const html = await res.text();
          const host = document.getElementById("sidenav-container");
          host.innerHTML = html;
          const chatLink = host.querySelector("#navChat");
          if (chatLink) chatLink.classList.add("bg-gray-100");
          const logoutBtn = host.querySelector("#btnLogout");
          if (logoutBtn) {
            logoutBtn.addEventListener("click", function (e) {
              e.preventDefault();
              try {
                localStorage.removeItem("auth");
                sessionStorage.clear();
              } catch {}
              window.location.href = "../../../API/API_logout_User.php";
            });
          }
        } catch (e) {
          console.error("Không thể tải Sidenav_Nhatuyendung.html", e);
        }
      })();

      function showToast(msg, type = "success") {
        const old = document.querySelector(".toast");
        if (old) old.remove();
        const el = document.createElement("div");
        el.className = "toast";
        let bg = "#16a34a",
          icon = '<i class="fas fa-check-circle"></i>';
        if (type === "error") {
          bg = "#dc2626";
          icon = '<i class="fas fa-times-circle"></i>';
        } else if (type === "warning") {
          bg = "#f59e0b";
          icon = '<i class="fas fa-exclamation-triangle"></i>';
        } else if (type === "info") {
          bg = "#2563eb";
          icon = '<i class="fas fa-info-circle"></i>';
        }
        el.style.backgroundColor = bg;
        el.innerHTML = icon + " <span>" + msg + "</span>";
        document.body.appendChild(el);
        setTimeout(() => el.classList.add("show"), 10);
        setTimeout(() => {
          el.classList.remove("show");
          setTimeout(() => el.remove(), 250);
        }, 2600);
      }
    </script>

    <!-- Main wrapper -->
    <div
      class="relative h-full max-h-screen transition-all duration-200 ease-in-out xl:ml-68"
    >
      <!-- Navbar overlay -->
      <nav
        class="absolute z-20 flex items-center justify-between w-full px-6 py-2 -mt-56 text-white"
      >
        <div class="flex items-center justify-between w-full px-6 py-1 mx-auto">
          <div>
            <ol class="flex flex-wrap pt-1 pl-2 pr-4 bg-transparent rounded-lg">
              <li class="leading-normal text-sm opacity-75">
                <a class="opacity-75" href="UI_Nhatuyendung_Trangchu.html"
                  >Trang chủ</a
                >
              </li>
              <li
                class="text-sm pl-2 capitalize leading-normal before:float-left before:pr-2 before:content-['/']"
                aria-current="page"
              >
                Chat
              </li>
            </ol>
            <h6 class="mb-2 ml-2 font-bold text-white">
              Trao đổi với ứng viên
            </h6>
          </div>
          <div class="hidden sm:block text-sm">
            <i class="fa fa-user mr-1"></i>
            <span id="ntdEmail" class="font-semibold">—</span>
          </div>
        </div>
      </nav>

      <!-- Header card -->
      <div class="relative w-full mx-auto mt-60">
        <div
          class="relative flex flex-col flex-auto min-w-0 p-4 mx-6 overflow-hidden break-words bg-white border-0 shadow-3xl rounded-2xl bg-clip-border"
        >
          <div class="flex flex-wrap -mx-3 items-center">
            <div class="w-auto px-3 my-auto">
              <div class="h-full">
                <h5 class="mb-1 text-slate-800" id="oTenCongTy">
                  Nhà tuyển dụng
                </h5>
                <p
                  class="mb-0 font-semibold leading-normal text-sm text-slate-500"
                >
                  <i class="ni ni-email-83 mr-1"></i><span id="oEmail">—</span>
                </p>
              </div>
            </div>
            <div class="w-full px-3 mt-4 md:w-auto md:ml-auto md:mt-0">
              <div class="flex items-center gap-2">
                <div class="relative">
                  <span
                    class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"
                    ><i class="fas fa-search"></i
                  ></span>
                  <input
                    id="searchInput"
                    type="text"
                    placeholder="Tìm theo tên ứng viên, chức danh..."
                    class="pl-9 text-sm rounded-lg border border-gray-300 bg-white py-2 pr-3 text-gray-700 focus:border-blue-500 focus:outline-none"
                  />
                </div>
                <button id="btnReload" class="btn-ghost hover:bg-gray-50">
                  <i class="fas fa-sync mr-1"></i>Tải lại
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Content -->
      <div class="w-full p-6 mx-auto">
        <div class="flex flex-wrap -mx-3">
          <!-- List threads -->
          <div class="w-full max-w-full px-3 lg:w-4/12">
            <div
              class="relative flex flex-col min-w-0 break-words bg-white border-0 shadow-xl rounded-2xl bg-clip-border"
            >
              <div class="rounded-t-2xl p-4 border-b">
                <p class="mb-0 font-semibold">Cuộc trò chuyện được kết nối</p>
              </div>
              <div id="threadList" class="flex-auto p-0"></div>
              <div id="emptyThreads" class="p-4 hidden">
                <div class="p-4 rounded-xl border text-center text-slate-500">
                  Chưa có cuộc trò chuyện. Hãy mời phỏng vấn (đặt trạng thái
                  <b>MoiPhongVan</b>) để mở chat.
                </div>
              </div>
            </div>
          </div>

          <!-- Chat box -->
          <div class="w-full max-w-full px-3 mt-6 lg:mt-0 lg:w-8/12">
            <div
              class="relative flex flex-col min-w-0 break-words bg-white border-0 shadow-xl rounded-2xl bg-clip-border h-[70vh]"
            >
              <div class="p-4 border-b flex items-center justify-between">
                <div>
                  <h6 id="chatTitle" class="font-semibold">
                    Chọn cuộc trò chuyện
                  </h6>
                  <div id="jobInfo" class="text-sm text-slate-500"></div>
                </div>
                <div class="flex items-center gap-2">
                  <!-- NÚT TẠO LỊCH PHỎNG VẤN (mở modal) -->
                  <button
                    id="btnCreateInterview"
                    type="button"
                    class="btn-primary hidden"
                    title="Tạo lịch phỏng vấn với ứng viên này"
                  >
                    <i class="fa fa-calendar-plus"></i> Tạo lịch PV
                  </button>
                  <div id="threadMeta" class="text-xs text-slate-400"></div>
                </div>
              </div>

              <!-- Controller: Older / Newest -->
              <div class="px-4 pt-3 flex items-center gap-2">
                <button id="btnOlder" type="button" class="btn-light">
                  <i class="fa fa-chevron-up mr-1"></i> Tin nhắn cũ hơn
                </button>
                <button id="btnNewest" type="button" class="btn-light">
                  <i class="fa fa-bolt mr-1"></i> Mới nhất
                </button>
                <span id="rangeInfo" class="text-xs text-slate-500 ml-auto"
                  >—</span
                >
              </div>

              <div
                id="messages"
                class="flex-1 overflow-y-auto p-4 space-y-2 bg-gray-50"
              ></div>

              <form id="composer" class="p-4 border-t flex gap-2">
                <input
                  id="msgInput"
                  type="text"
                  class="form-input flex-1"
                  placeholder="Nhập tin nhắn..."
                  autocomplete="off"
                />
                <button id="btnSend" class="btn-primary" type="submit">
                  <i class="fa fa-paper-plane"></i> Gửi
                </button>
              </form>
            </div>
          </div>
        </div>

        <footer class="pt-4">
          <div class="w-full px-6 mx-auto">
            <div class="text-center text-sm text-slate-500">
              ©
              <script>
                document.write(new Date().getFullYear());
              </script>
              Duantuyendung
            </div>
          </div>
        </footer>
      </div>
    </div>

    <!-- MODAL TẠO LỊCH PHỎNG VẤN -->
    <div id="lpvBackdrop" class="modal-backdrop"></div>
    <div
      id="lpvModal"
      class="modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="lpvTitle"
    >
      <div class="modal-card">
        <div class="modal-head">
          <h4 id="lpvTitle" class="font-bold">Tạo lịch phỏng vấn</h4>
          <button id="lpvClose" class="btn-ghost" title="Đóng">
            <i class="fa fa-times"></i>
          </button>
        </div>
        <form id="lpvForm">
          <div class="modal-body grid gap-3">
            <div class="text-sm text-slate-600" id="lpvInfo">—</div>
            <div>
              <label class="block text-sm font-semibold mb-1">Ngày & giờ</label>
              <input
                id="lpvDateTime"
                type="datetime-local"
                class="form-input"
                required
              />
              <div id="lpvErrTime" class="text-danger">
                Thời điểm phải ở tương lai.
              </div>
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1">Hình thức</label>
              <select id="lpvHinhThuc" class="form-input">
                <option>Online</option>
                <option>Offline</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1">Ghi chú</label>
              <textarea
                id="lpvGhiChu"
                rows="2"
                class="form-input"
                placeholder="Link meet / Địa điểm / Người phỏng vấn..."
              ></textarea>
            </div>
          </div>
          <div class="modal-foot">
            <a
              id="lpvOpenPage"
              class="btn-ghost"
              href="#"
              target="_blank"
              rel="noopener"
            >
              <i class="fa fa-list mr-1"></i> Xem tất cả lịch
            </a>
            <button type="button" id="lpvCancel" class="btn-ghost">Hủy</button>
            <button type="submit" id="lpvSubmit" class="btn-primary">
              <i class="fa fa-calendar-plus mr-1"></i> Tạo lịch
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- App -->
    <script type="module">
      import { API_BASE } from "../../assets/js/config.js";

      // ===== Auth & header =====
      const auth = (() => {
        try {
          return JSON.parse(localStorage.getItem("auth") || "null");
        } catch {
          return null;
        }
      })();
      const emailStr = auth?.email || auth?.Email || "—";
      document.getElementById("ntdEmail").textContent = emailStr;
      document.getElementById("oEmail").textContent = emailStr;

      // ===== Elements =====
      const threadList = document.getElementById("threadList");
      const emptyThreads = document.getElementById("emptyThreads");
      const messagesEl = document.getElementById("messages");
      const chatTitle = document.getElementById("chatTitle");
      const jobInfo = document.getElementById("jobInfo");
      const threadMeta = document.getElementById("threadMeta");
      const searchInput = document.getElementById("searchInput");
      const btnReload = document.getElementById("btnReload");
      const composer = document.getElementById("composer");
      const msgInput = document.getElementById("msgInput");
      const btnSend = document.getElementById("btnSend");
      const btnOlder = document.getElementById("btnOlder");
      const btnNewest = document.getElementById("btnNewest");
      const rangeInfo = document.getElementById("rangeInfo");
      const btnCreateInterview = document.getElementById("btnCreateInterview");

      // Modal elements
      const lpvBackdrop = document.getElementById("lpvBackdrop");
      const lpvModal = document.getElementById("lpvModal");
      const lpvForm = document.getElementById("lpvForm");
      const lpvInfo = document.getElementById("lpvInfo");
      const lpvDateTime = document.getElementById("lpvDateTime");
      const lpvHinhThuc = document.getElementById("lpvHinhThuc");
      const lpvGhiChu = document.getElementById("lpvGhiChu");
      const lpvErrTime = document.getElementById("lpvErrTime");
      const lpvSubmit = document.getElementById("lpvSubmit");
      const lpvCancel = document.getElementById("lpvCancel");
      const lpvClose = document.getElementById("lpvClose");
      const lpvOpenPage = document.getElementById("lpvOpenPage");

      // ===== Fetch helpers =====
      async function parseMaybeJSON(res) {
        const ct = (res.headers.get("content-type") || "").toLowerCase();
        const txt = await res.text();
        try {
          if (!ct.includes("application/json")) throw new Error("not-json");
          return JSON.parse(txt);
        } catch (e) {
          console.error("API returned non-JSON:\\n", txt);
          throw new Error("API không trả JSON hợp lệ (xem console).");
        }
      }
      async function jget(u) {
        const res = await fetch(u, { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status + " @ " + u);
        return parseMaybeJSON(res);
      }
      async function jpost(u, data) {
        const res = await fetch(u, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });
        if (!res.ok) throw new Error("HTTP " + res.status + " @ " + u);
        return parseMaybeJSON(res);
      }

      // ===== State =====
      let MaNTD = auth?.MaNTD || auth?.MaNhatuyendung || null;
      let threads = [];
      let filteredThreads = [];
      let currentThread = null;

      const PAGE = 6;
      let viewPage = 0; // 0 = newest page
      let cachedLimit = PAGE;
      let cachedMessages = []; // oldest->newest
      let pollTimer = null;
      let sending = false;
      let olderEnded = false;

      // dedupe helpers
      let seen = new Set();
      const keyFor = (m) =>
        m?.MaMsg
          ? `id:${m.MaMsg}`
          : `ts:${m.CreatedAt}|${m.SenderType || ""}|${m.NoiDung || ""}`;
      function seedSeenFrom(arr) {
        seen = new Set();
        for (const m of arr || []) seen.add(keyFor(m));
      }
      function mergeUnique(oldArr, newArr) {
        const out = oldArr.slice();
        for (const m of newArr || []) {
          const k = keyFor(m);
          if (!seen.has(k)) {
            seen.add(k);
            out.push(m);
          }
        }
        return out;
      }

      // ===== Profile =====
      async function loadProfile() {
        try {
          const url =
            API_BASE +
            "API_show_Nhatuyendung.php?MaTK=" +
            encodeURIComponent(auth?.MaTK || auth?.userId || "");
          const js = await jget(url);
          const me =
            js?.status === "success" && Array.isArray(js.data)
              ? js.data[0]
              : null;
          if (me) {
            MaNTD = Number(me.MaNTD);
            document.getElementById("oTenCongTy").textContent =
              me.TenCongTy || "Nhà tuyển dụng";
          }
        } catch {}
      }

      // ===== Threads =====
      function threadItemTemplate(th) {
        const name = th.HoTen || "Ứng viên";
        const sub = [th.ChucDanh, th.DiaDiemLamViec]
          .filter(Boolean)
          .join(" • ");
        return `
          <div class="flex items-center justify-between">
            <div class="truncate">
              <div class="font-semibold text-slate-800 truncate">${name}</div>
              <div class="text-xs text-slate-500 truncate">${sub}</div>
            </div>
            <i class="fa fa-comments text-slate-400 ml-3"></i>
          </div>
        `;
      }
      function renderThreads() {
        threadList.innerHTML = "";
        const q = (searchInput.value || "").trim().toLowerCase();
        filteredThreads = (threads || []).filter((t) => {
          const a = (t.HoTen || "").toLowerCase(),
            b = (t.ChucDanh || "").toLowerCase(),
            c = (t.DiaDiemLamViec || "").toLowerCase();
          return !q || a.includes(q) || b.includes(q) || c.includes(q);
        });
        if (!filteredThreads.length) {
          emptyThreads.classList.remove("hidden");
          return;
        }
        emptyThreads.classList.add("hidden");
        filteredThreads.forEach((th) => {
          const row = document.createElement("button");
          row.type = "button";
          row.className =
            "chat-list-item w-full text-left p-3 border-b hover:bg-gray-50";
          row.innerHTML = threadItemTemplate(th);
          row.addEventListener("click", () => openThread(th, row));
          threadList.appendChild(row);
        });
      }
      function setActiveRow(row) {
        threadList
          .querySelectorAll(".chat-list-item")
          .forEach((x) => x.classList.remove("active"));
        row?.classList.add("active");
      }
      async function loadThreads() {
        if (!MaNTD) return;
        const url = `${API_BASE}API_chat_list_threads.php?role=NhaTuyenDung&MaNTD=${encodeURIComponent(
          MaNTD
        )}`;
        const res = await jget(url);
        threads = res?.ok ? res.threads || [] : [];
        renderThreads();
        const savedThreadId = localStorage.getItem("currentThreadId");
        if (savedThreadId) {
          const savedThread = threads.find(
            (t) => String(t.MaThread) === String(savedThreadId)
          );
          if (savedThread) {
            const row = Array.from(threadList.children).find(
              (r, i) =>
                String(filteredThreads[i]?.MaThread) === String(savedThreadId)
            );
            if (row) openThread(savedThread, row);
          }
        }
      }

      // ===== Messages =====
      function formatTime(ts) {
        try {
          const d = new Date(String(ts).replace(" ", "T"));
          return d.toLocaleTimeString("vi-VN", {
            hour: "2-digit",
            minute: "2-digit",
          });
        } catch {
          return ts || "";
        }
      }
      function renderOneMessage(m, position = "append") {
        const mine = m.SenderType === "NhaTuyenDung";
        const wrap = document.createElement("div");
        wrap.className = `flex ${mine ? "justify-end" : "justify-start"}`;
        wrap.innerHTML = `
          <div class="bubble ${mine ? "mine" : "other"} shadow">
            <div class="text-sm font-medium whitespace-pre-wrap">${(
              m.NoiDung || ""
            )
              .replace(/</g, "&lt;")
              .replace(/>/g, "&gt;")}</div>
            <div class="text-[11px] text-slate-500 mt-1">${formatTime(
              m.CreatedAt
            )}</div>
          </div>`;
        if (position === "prepend")
          messagesEl.insertBefore(wrap, messagesEl.firstChild);
        else messagesEl.appendChild(wrap);
      }
      function renderSlice(arrOldestToNewest, page) {
        messagesEl.innerHTML = "";
        const total = arrOldestToNewest.length;
        const end = total - page * PAGE;
        const start = Math.max(0, end - PAGE);
        const slice = arrOldestToNewest.slice(start, end);
        slice.forEach((m) => renderOneMessage(m, "append"));
      }
      async function fetchNewestChunk(limit) {
        const r = await jget(
          `${API_BASE}API_chat_fetch.php?MaThread=${currentThread.MaThread}&limit=${limit}`
        );
        return Array.isArray(r?.messages) ? r.messages : [];
      }

      async function openThread(th, rowEl) {
        currentThread = th;
        localStorage.setItem("currentThreadId", th.MaThread);
        setActiveRow(rowEl);
        chatTitle.textContent = th.HoTen || "Ứng viên";
        jobInfo.textContent = `Bài ứng tuyển: ${th.ChucDanh || ""} · ${
          th.DiaDiemLamViec || ""
        }`;
        threadMeta.textContent = `MaTin #${th.MaTin} • MaUV #${th.MaUngVien}`;

        // bật nút tạo lịch khi trạng thái cho phép
        if (th.TrangThai === "MoiPhongVan")
          btnCreateInterview.classList.remove("hidden");
        else btnCreateInterview.classList.add("hidden");

        // Cập nhật link "Xem tất cả lịch" trong modal
        const q = new URLSearchParams({
          MaTin: String(th.MaTin || ""),
          MaUngVien: String(th.MaUngVien || ""),
        });
        lpvOpenPage.href = `UI_TD_Lichphongvan.html?${q.toString()}`;

        // Prefill info modal
        lpvInfo.textContent = `Ứng viên: ${th.HoTen || ""} • Tin: ${
          th.ChucDanh || ""
        } (${th.DiaDiemLamViec || ""})`;

        viewPage = 0;
        cachedLimit = PAGE;
        olderEnded = false;
        const arr = await fetchNewestChunk(cachedLimit);
        seedSeenFrom(arr);
        cachedMessages = arr.slice();
        renderSlice(cachedMessages, viewPage);
        startPolling();
      }

      // ===== Older / Newest =====
      btnNewest.addEventListener("click", async () => {
        if (!currentThread) return;
        stopPolling();
        viewPage = 0;
        cachedLimit = PAGE;
        olderEnded = false;
        const arr = await fetchNewestChunk(cachedLimit);
        seedSeenFrom(arr);
        cachedMessages = arr.slice();
        renderSlice(cachedMessages, viewPage);
        startPolling();
      });

      btnOlder.addEventListener("click", async () => {
        if (!currentThread || olderEnded) return;
        btnOlder.disabled = true;
        btnOlder.innerHTML =
          '<i class="fa fa-spinner fa-spin mr-1"></i> Đang tải...';
        try {
          const before = cachedMessages.length;
          const end = before - viewPage * PAGE;
          const start = Math.max(0, end - PAGE);
          if (start === 0) {
            cachedLimit += PAGE;
            const arr = await fetchNewestChunk(cachedLimit);
            seedSeenFrom(arr);
            cachedMessages = arr.slice();
            const after = cachedMessages.length;
            if (after > before) {
              viewPage += 1;
              renderSlice(cachedMessages, viewPage);
            } else {
              olderEnded = true;
              showToast("Đã hết tin nhắn cũ hơn.", "info");
            }
          } else {
            viewPage += 1;
            renderSlice(cachedMessages, viewPage);
          }
        } catch {
          showToast("Lỗi tải tin nhắn cũ hơn", "error");
        } finally {
          btnOlder.disabled = olderEnded ? true : false;
          btnOlder.innerHTML =
            '<i class="fa fa-chevron-up mr-1"></i> Tin nhắn cũ hơn';
        }
      });

      // ===== Poll newest =====
      function startPolling() {
        stopPolling();
        pollTimer = setInterval(doPoll, 1500);
      }
      function stopPolling() {
        if (pollTimer) clearInterval(pollTimer);
        pollTimer = null;
      }
      async function doPoll() {
        try {
          if (!currentThread || viewPage !== 0) return;
          const last = cachedMessages[cachedMessages.length - 1];
          const since = last?.CreatedAt
            ? `&since=${encodeURIComponent(last.CreatedAt)}`
            : "";
          const r = await jget(
            `${API_BASE}API_chat_fetch.php?MaThread=${currentThread.MaThread}${since}&limit=${PAGE}`
          );
          const arr = Array.isArray(r?.messages) ? r.messages : [];
          if (arr.length) {
            const merged = mergeUnique(cachedMessages, arr);
            cachedMessages = merged.slice(-cachedLimit);
            renderSlice(cachedMessages, 0);
          }
        } catch {}
      }

      // ===== Send message =====
      composer.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!currentThread || sending) return;
        const text = msgInput.value.trim();
        if (!text) return;
        sending = true;
        btnSend.disabled = true;
        try {
          const r = await jpost(`${API_BASE}API_chat_send.php`, {
            MaThread: currentThread.MaThread,
            SenderType: "NhaTuyenDung",
            NoiDung: text,
            MaTK: auth?.MaTK || auth?.userId || null,
          });
          if (r?.ok) {
            viewPage = 0;
            cachedLimit = PAGE;
            olderEnded = false;
            const arr = await fetchNewestChunk(cachedLimit);
            seedSeenFrom(arr);
            cachedMessages = arr.slice();
            renderSlice(cachedMessages, 0);
            startPolling();
            msgInput.value = "";
          } else {
            showToast(r?.error || "Gửi tin nhắn thất bại!", "error");
          }
        } catch (err) {
          showToast(err.message || "Lỗi kết nối khi gửi!", "error");
        } finally {
          sending = false;
          btnSend.disabled = false;
        }
      });

      // ======= Modal: Tạo lịch PV (inline) =======
      function openModal() {
        // set min cho datetime-local = now (local) => ngăn chọn quá khứ
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); // normalize to local for input
        const minStr = now.toISOString().slice(0, 16); // YYYY-MM-DDTHH:MM
        lpvDateTime.min = minStr;
        // đề xuất mặc định +24h
        const suggest = new Date(now.getTime() + 24 * 60 * 60 * 1000);
        lpvDateTime.value = suggest.toISOString().slice(0, 16);
        lpvErrTime.style.display = "none";
        lpvBackdrop.classList.add("show");
        lpvModal.classList.add("show");
      }
      function closeModal() {
        lpvBackdrop.classList.remove("show");
        lpvModal.classList.remove("show");
      }

      btnCreateInterview.addEventListener("click", () => {
        if (!currentThread) return;
        openModal();
      });
      lpvCancel.addEventListener("click", closeModal);
      lpvClose.addEventListener("click", closeModal);
      lpvBackdrop.addEventListener("click", closeModal);

      function isFutureLocal(dtStr) {
        // dtStr: "YYYY-MM-DDTHH:MM"
        if (!dtStr) return false;
        const local = new Date(dtStr);
        // nowLocal computed via new Date()
        const now = new Date();
        return local.getTime() > now.getTime();
      }

      lpvForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!currentThread || !MaNTD) {
          showToast("Thiếu thông tin tạo lịch.", "error");
          return;
        }
        const dt = lpvDateTime.value; // YYYY-MM-DDTHH:MM
        if (!dt) {
          lpvErrTime.textContent = "Vui lòng chọn thời điểm.";
          lpvErrTime.style.display = "block";
          return;
        }
        if (!isFutureLocal(dt)) {
          lpvErrTime.textContent = "Thời điểm phải ở tương lai.";
          lpvErrTime.style.display = "block";
          return;
        }
        lpvErrTime.style.display = "none";
        const dtSQL = dt.replace("T", " ") + ":00";

        lpvSubmit.disabled = true;
        lpvSubmit.innerHTML =
          '<i class="fa fa-spinner fa-spin mr-1"></i> Đang tạo...';
        try {
          const js = await jpost(`${API_BASE}API_lpv_create.php`, {
            MaNTD: Number(MaNTD),
            MaTin: Number(currentThread.MaTin),
            MaUngVien: Number(currentThread.MaUngVien),
            NgayGioPhongVan: dtSQL,
            HinhThuc: lpvHinhThuc.value,
            GhiChu: lpvGhiChu.value.trim(),
          });
          if (!js.ok) {
            showToast(js.error || "Tạo lịch thất bại", "error");
          } else {
            showToast("Đã tạo lịch #" + js.MaLichPV, "info");
            closeModal();
          }
        } catch (err) {
          showToast(err.message || "Lỗi kết nối", "error");
        } finally {
          lpvSubmit.disabled = false;
          lpvSubmit.innerHTML =
            '<i class="fa fa-calendar-plus mr-1"></i> Tạo lịch';
        }
      });

      // ===== Events =====
      searchInput.addEventListener("input", renderThreads);
      btnReload.addEventListener("click", loadThreads);

      // ===== Init =====
      (async function init() {
        await loadProfile();
        await loadThreads();
      })();
    </script>
  </body>
</html>
